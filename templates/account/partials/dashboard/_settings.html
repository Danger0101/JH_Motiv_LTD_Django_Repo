<div x-data="{ settingsTab: 'password' }">
    <div class="mb-8">
        <div class="sm:hidden">
            <label for="settings-tab-select" class="sr-only">Select a setting</label>
            <select id="settings-tab-select" 
                    class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 bg-gray-50 text-gray-900 font-medium"
                    x-model="settingsTab">
                <option value="password">Change Password</option>
                <option value="email">Email Addresses</option>
                <option value="social">Connected Accounts</option>
                <option value="address">Saved Addresses</option>
                <option value="prefs">Email Preferences</option>
            </select>
        </div>

        <div class="hidden sm:block overflow-x-auto">
            <nav class="flex space-x-2 p-1 bg-gray-100 rounded-xl" aria-label="Tabs">
            <button @click="settingsTab = 'password'" 
                    :class="settingsTab === 'password' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Change Password
            </button>
            <button @click="settingsTab = 'email'" 
                    :class="settingsTab === 'email' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Email Addresses
            </button>
            <button @click="settingsTab = 'social'" 
                    :class="settingsTab === 'social' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Connected Accounts
            </button>
            <button @click="settingsTab = 'address'" 
                    :class="settingsTab === 'address' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Saved Addresses
            </button>
            {% if has_earnings_profile %}
            <button @click="settingsTab = 'payout'" 
                    :class="settingsTab === 'payout' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Payout Settings
            </button>
            {% endif %}
            <button @click="settingsTab = 'prefs'" 
                    :class="settingsTab === 'prefs' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    class="flex-1 whitespace-nowrap py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none">
                Email Preferences
            </button>
            </nav>
        </div>
    </div>

    <div class="mt-4">
        <div x-show="settingsTab === 'password'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200" 
                 hx-get="{% url 'accounts:password_change' %}" 
                 hx-trigger="intersect once">
                <div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>
            </div>
        </div>

        <div x-show="settingsTab === 'email'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200" 
                 hx-get="{% url 'accounts:account_email' %}" 
                 hx-trigger="intersect once">
                 <div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>
            </div>
        </div>

        <div x-show="settingsTab === 'social'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200" 
                 hx-get="{% url 'accounts:socialaccount_connections' %}" 
                 hx-trigger="intersect once">
                 <div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>
            </div>
        </div>

        <div x-show="settingsTab === 'address'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200">
                {% if user.addresses.exists %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for address in user.addresses.all %}
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative">
                            {% if address.is_default %}
                                <span class="absolute top-4 right-4 inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Default</span>
                            {% endif %}
                            <div class="flex items-start">
                                <div class="bg-blue-50 p-2 rounded-lg text-blue-600 mr-3">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900">{{ address.full_name }}</p>
                                    <p class="text-sm text-gray-600 mt-1">{{ address.street_address }}</p>
                                    <p class="text-sm text-gray-600">{{ address.city }}, {{ address.postcode }}</p>
                                    <p class="text-sm text-gray-500 mt-1 uppercase tracking-wide text-xs">{{ address.country }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <div class="bg-white p-3 rounded-full inline-block mb-3 shadow-sm">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        </div>
                        <p class="text-gray-500 text-sm">No saved addresses found.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if has_earnings_profile %}
        <div x-show="settingsTab === 'payout'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200"
                 hx-get="{% url 'payments:payout_settings' %}" 
                 hx-trigger="intersect once">
                 <div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div></div>
            </div>
        </div>
        {% endif %}

        <div x-show="settingsTab === 'prefs'" x-cloak>
            <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200">
                {% with marketing_preference=user.marketing_preference %}                                    
                <div hx-ext="django-messages">
                <div hx-listen="messages" class="hidden"></div>

                <form hx-post="{% url 'accounts:update_marketing_preference' %}" hx-target="#marketing-status">
                    {% csrf_token %}
                    <label class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <div class="bg-indigo-50 p-2 rounded-lg text-indigo-600 mr-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900">Marketing Communications</h4>
                                <p class="text-sm text-gray-500">Receive updates about new features, promotions, and coaching tips.</p>
                            </div>
                        </div>
                        <div class="relative inline-flex items-center">
                            <input type="checkbox" name="is_subscribed" {% if marketing_preference.is_subscribed %}checked{% endif %}
                                   class="sr-only peer"
                                   hx-post="{% url 'accounts:update_marketing_preference' %}" hx-trigger="change">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                    <div id="marketing-status" class="mt-3 text-right text-xs text-gray-500">
                        {% if marketing_preference.is_subscribed %}
                            <span class="text-green-600 font-bold">Subscribed</span>
                        {% else %}
                            <span class="text-gray-500 font-medium">Unsubscribed</span>
                        {% endif %}
                    </div>
                </form>
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
</div>