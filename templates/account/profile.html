{% extends 'base.html' %}
{% load static %}


{% block title %}My Account Dashboard{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/account.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container" x-data="{ activeTab: 'dashboard' }">
    
    <div class="profile-header">
        <div class="profile-header-left">
            <div>
                <h1 class="profile-title">
                    Welcome, {{ user.first_name|default:user.username }}
                </h1>
                <p class="profile-subtitle">Manage your account and sessions</p>
            </div>
        </div>
        <div class="profile-badges">
            {% if is_coach %}
                <span class="badge badge-coach">Coach</span>
            {% endif %}
            <span class="badge badge-client">Client</span>
        </div>
    </div>

    <div class="profile-layout">
        <aside class="profile-sidebar">
            <div>
                <div class="nav-menu">
                    <p class="nav-section-title">Menu</p>

                    <button @click="activeTab = 'dashboard'; mobileMenuOpen = false" 
                            :class="{'active': activeTab === 'dashboard'}"
                            class="nav-btn">
                        Dashboard
                    </button>

                    <button @click="activeTab = 'bookings'" 
                            :class="{'active': activeTab === 'bookings'}"
                            class="nav-btn">
                        My Bookings
                    </button>

                    <button @click="activeTab = 'credits'" 
                            :class="{'active': activeTab === 'credits'}"
                            class="nav-btn">
                        My Credits & Plans
                    </button>

                    <button @click="activeTab = 'order_history'"
                            :class="{'active': activeTab === 'order_history'}"
                            class="nav-btn">
                        Order History
                    </button>

                    <button @click="activeTab = 'settings'" 
                            :class="{'active': activeTab === 'settings'}"
                            class="nav-btn">
                        Profile Settings
                    </button>

                    {% if is_coach %}
                    <p class="nav-section-title">Coach Area</p>
                    <button @click="activeTab = 'coach_portal'" 
                            :class="{'active': activeTab === 'coach_portal'}"
                            class="nav-btn">
                        Coach Portal
                    </button>
                    {% endif %}

                    {% if is_staff %}
                    <p class="nav-section-title">Admin</p>
                    <button @click="activeTab = 'staff'" 
                            :class="{'active': activeTab === 'staff'}"
                            class="nav-btn">
                        Staff Dashboard
                    </button>
                    {% endif %}
                    
                    <div class="sidebar-separator">
                        <a href="{% url 'account_logout' %}" class="nav-btn nav-btn-logout">
                            Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <main class="profile-main">
            
            <div x-show="activeTab === 'dashboard'" x-cloak style="display: none;">
                <h2 class="section-header">Dashboard</h2>

                {% with my_taster=user.free_offers.all|first %}
                    {% if my_taster and not my_taster.is_redeemed and not my_taster.is_expired %}
                        <div class="dashboard-card taster-card">
                            <h3 class="card-subtitle">Free Taster Session</h3>
                            {% if my_taster.is_approved %}
                                <div class="card-cta-row">
                                    <div>
                                        <p class="text-positive">✅ Approved! Ready to book.</p>
                                        <p class="text-meta">Expires: {{ my_taster.redemption_deadline|date:"M d, Y" }}</p>
                                    </div>
                                    <button onclick="document.querySelector('[x-data]').__x.$data.openBooking = true" 
                                            class="btn-primary btn-auto">
                                        Book Now
                                    </button>
                                </div>
                            {% else %}
                                <p class="text-pending">⏳ Request pending approval.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}

                <div class="dashboard-card booking-cta-card">
                    <div>
                        <h3 class="card-subtitle-alt">Book a Session</h3>
                        <p class="card-text-alt">You have valid credits available.</p>
                    </div>
                    <div x-data="{ openBooking: false }">
                        <button @click="openBooking = !openBooking" class="btn-primary btn-auto">
                            Book New Session
                        </button>
                        <div x-show="openBooking" class="modal-overlay" x-cloak>
                            <div class="modal-content" @click.away="openBooking = false">
                                <button @click="openBooking = false" class="modal-close-btn">✕</button>
                                <h2 class="modal-title">Book a Session</h2>
                                <div hx-get="{% url 'coaching_booking:profile_book_session' %}" hx-trigger="intersect" hx-swap="innerHTML">
                                    <div class="modal-loading">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="profile-header">
                        <h3 class="card-subtitle">Upcoming Sessions</h3>
                        <button @click="activeTab = 'bookings'" class="link-button">View All</button>
                    </div>
                    <div id="profile-bookings-dashboard">
                         {% include 'account/profile_bookings.html' %}
                    </div>
                </div>
            </div>

            <div x-show="activeTab === 'bookings'" x-cloak style="display: none;">
                <h2 class="section-header">My Bookings</h2>
                <div id="profile-bookings-full">
                    {% include 'account/profile_bookings.html' %}
                </div>
            </div>

            <div x-show="activeTab === 'credits'" x-cloak style="display: none;">
                <h2 class="section-header">Credits & Plans</h2>
                
                {% if available_credits %}
                    <div class="credits-grid">
                        {% for credit in available_credits %}
                            <div class="credit-card">
                                <div>
                                    <p class="credit-name">{{ credit.offering.name }}</p>
                                    <p class="credit-expiry">Exp: {{ credit.expiration_date|date:"M d, Y" }}</p>
                                </div>
                                <span class="status-pill">
                                    {{ credit.remaining_sessions }} left
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state-card">
                        <p class="empty-state-text">You don't have any active credits.</p>
                        <a href="{% url 'coaching_booking:offer-list' %}" class="btn-primary btn-auto">Purchase a Plan</a>
                    </div>
                {% endif %}
            </div>

            <I have removed the mobile sidebar functionality (`mobileMenuOpen`) as it seemed complex and better handled by a more robust solution if needed. The layout is now a simpler two-column grid on larger screens.

These changes should give you a clean, Tailwind-free profile page that relies on your project's custom CSS, making it easier to maintain and extend.

Let me know if you'd like to tackle another component!

<!--
[PROMPT_SUGGESTION]Now, let's refactor the `navbar.html` partial to remove its Tailwind classes and use `navbar.css` exclusively.[/PROMPT_SUGGESTION]
[PROMPT_SUGGESTION]Can you help me create a style guide page based on the CSS variables in `base.css`?[/PROMPT_SUGGESTION]
-->
                <h2 class="section-header">Order History</h2>
            
                <div class="order-history-sections">
                    <div>
                        <h3 class="card-subtitle">Retail Orders</h3>
                        {% if ecomm_orders %}
                            <div class="history-table-wrapper">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Date</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for order in ecomm_orders %}
                                            <tr>
                                                <td class="font-medium text-gray-900">#{{ order.id }}</td>
                                                <td>{{ order.created_at|date:"d M Y" }}</td>
                                                <td>£{{ order.total_paid|floatformat:2 }}</td>
                                                <td>
                                                    <span class="status-pill">{{ order.printful_order_status|default:"Processing"|title }}</span>
                                                </td>
                                                <td class="text-right">
                                                    <a href="{% url 'accounts:generate_invoice_pdf' order.id %}" target="_blank" class="link-button">
                                                        Invoice
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="empty-state-text">You have not made any shop purchases yet.</p>
                        {% endif %}
                    </div>
            
                    <div>
                        <h3 class="card-subtitle">Coaching Orders</h3>
                        {% if coaching_orders %}
                             <div class="history-table-wrapper">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Date</th>
                                            <th>Plan</th>
                                            <th>Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for order in coaching_orders %}
                                        <tr>
                                            <td class="font-medium text-gray-900">#{{ order.id }}</td>
                                            <td>{{ order.created_at|date:"d M Y" }}</td>
                                            <td>{{ order.enrollment.offering.name }}</td>
                                            <td>£{{ order.total_paid|floatformat:2 }}</td>
                                            <td class="text-right">
                                                <a href="{% url 'accounts:generate_invoice_pdf' order.id %}" target="_blank" class="link-button">
                                                    Invoice
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="empty-state-text">You have not purchased any coaching plans yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div x-show="activeTab === 'settings'" x-cloak>
                <h2 class="section-header">Profile Settings</h2>
                
                <div x-data="{ openSetting: null }">
                    
                    <div class="settings-item">
                        <button @click="openSetting = (openSetting === 'password' ? null : 'password')" class="settings-trigger">
                            <span class="settings-trigger-text">Change Password</span>
                            <span class="settings-trigger-icon" :class="{'rotate-180': openSetting === 'password'}">▼</span>
                        </button>
                        <div x-show="openSetting === 'password'" x-collapse>
                            <div class="settings-content" 
                                 hx-get="{% url 'accounts:password_change' %}" 
                                 hx-trigger="intersect once">
                                <div class="modal-loading">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <button @click="openSetting = (openSetting === 'email' ? null : 'email')" class="settings-trigger">
                            <div class="settings-trigger-label">
                                <span class="settings-trigger-text">Email Addresses</span>
                                <span class="settings-trigger-subtext">{{ user.email }}</span>
                            </div>
                            <span class="settings-trigger-icon" :class="{'rotate-180': openSetting === 'email'}">▼</span>
                        </button>
                        <div x-show="openSetting === 'email'" x-collapse>
                            <div class="settings-content" 
                                 hx-get="{% url 'accounts:account_email' %}" 
                                 hx-trigger="intersect once">
                                 <div class="modal-loading">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <button @click="openSetting = (openSetting === 'prefs' ? null : 'prefs')" class="settings-trigger">
                            <span class="settings-trigger-text">Email Preferences</span>
                            <span class="settings-trigger-icon" :class="{'rotate-180': openSetting === 'prefs'}">▼</span>
                        </button>
                        <div x-show="openSetting === 'prefs'" x-collapse>
                            <div class="settings-content">
                                {% with marketing_preference=user.marketing_preference %}
                                <form hx-post="{% url 'accounts:update_marketing_preference' %}" hx-target="#marketing-status">
                                    {% csrf_token %}
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="is_subscribed" {% if marketing_preference.is_subscribed %}checked{% endif %} class="checkbox-input"
                                               hx-post="{% url 'accounts:update_marketing_preference' %}" hx-trigger="change">
                                        <span class="checkbox-text">Receive marketing emails and updates</span>
                                    </label>
                                    <div id="marketing-status" class="marketing-status-text"></div>
                                </form>
                                {% endwith %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            {% if is_coach %}
            <div x-show="activeTab === 'coach_portal'" x-cloak>
                <h2 class="section-header">Coach Portal</h2>
                
                <div class="gcal-card">
                    <div class="gcal-info">
                        <img src="https://www.gstatic.com/images/branding/product/1x/calendar_48dp.png" alt="GCal" class="gcal-icon">
                        <div>
                            <h4 class="gcal-title">Google Calendar</h4>
                            <p class="gcal-status">
                                {% if user.coach_profile.google_credentials %}Synced{% else %}Not Connected{% endif %}
                            </p>
                        </div>
                    </div>
                     {% if user.coach_profile.google_credentials %}
                        <a href="{% url 'gcal:google_calendar_disconnect' %}" class="gcal-disconnect-link">Disconnect</a>
                    {% else %}
                        <a href="{% url 'gcal:google_calendar_init' %}" class="gcal-connect-btn">Connect</a>
                    {% endif %}
                </div>

                <div>
                    <h3 class="card-subtitle">My Clients</h3>
                    <div hx-get="{% url 'accounts:coach_clients_partial' %}" hx-trigger="load" hx-swap="innerHTML">
                        <div class="modal-loading">Loading clients...</div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if is_staff %}
            <div x-show="activeTab === 'staff'" x-cloak>
                <h2 class="section-header">Staff Dashboard</h2>
                <div class="staff-stats-grid">
                    <div class="stat-card">
                        <p class="stat-label">Dreamers Count</p>
                        <p class="stat-value">{{ staff_dreamer_count }}</p>
                    </div>
                    <div class="stat-card stat-card-link">
                        <a href="{% url 'admin:index' %}" target="_blank" class="link-button-strong">Access Django Admin &rarr;</a>
                    </div>
                </div>

                <div class="staff-lookup-section">
                    <h3 class="card-subtitle">Customer Lookup</h3>
                    <input type="text" 
                           class="form-input"
                           placeholder="Search by name, email, or username..."
                           hx-get="{% url 'accounts:staff_customer_lookup' %}"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#search-results">
                    <div id="search-results"></div>
                    <div id="customer-detail-panel"></div>
                </div>
            </div>
            {% endif %}

        </main>
    </div>
</div>
{% endblock %}
