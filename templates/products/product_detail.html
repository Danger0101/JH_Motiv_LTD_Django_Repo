{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Shop{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="container" x-data>
    <div class="product-detail-wrapper">
        
        <div role="region" aria-label="Product Image">
            <img src="{% if product.featured_image %}{{ product.featured_image.url }}{% else %}https://via.placeholder.com/500{% endif %}" 
                 alt="{{ product.name }}" 
                 class="detail-image">
        </div>

        <div>
            <h1 class="detail-title">{{ product.name }}</h1>
            <p class="detail-description">{{ product.description }}</p>

            {% if product.variants.all %}
                {% with first_variant=product.variants.first %}
                
                <div x-data="{ 
                    selectedColor: '{{ first_variant.color|default:"" }}',     
                    selectedSize: '{{ first_variant.size|default:"" }}',       
                    selectedVariantId: '{{ first_variant.id|default:'0' }}', 
                    currentPrice: '{{ first_variant.price|floatformat:2|default:'0.00' }}',
                    isInStock: true,
                    
                    variantMap: JSON.parse('{{ variant_lookup_json|escapejs }}'),
                    
                    findVariant: function() {
                        const key = this.selectedColor + '_' + this.selectedSize;
                        const data = this.variantMap[key] || null;

                        if (data) {
                            this.selectedVariantId = data.id;
                            this.currentPrice = data.price.toFixed(2);
                            this.isInStock = data.in_stock; 
                        } else {
                            this.selectedVariantId = '0'; 
                            this.isInStock = false;
                        }
                    },
                    
                    selectInitialVariant: function() {
                        this.findVariant();
                    }
                }" x-init="selectInitialVariant()">
                    
                    <div style="margin-bottom: 1.5rem;">
                        <span class="detail-price" x-text="'£' + currentPrice">
                            £{{ first_variant.price|floatformat:2 }}
                        </span>
                    </div>

                    <form action="{% url 'cart:add_to_cart' 0 %}" method="post" id="add-to-cart-form">
                        {% csrf_token %}
                        
                        <div class="option-group">
                            <h3 class="option-label">Color: 
                                <span class="option-value" x-text="selectedColor"></span>
                            </h3>
                            <div class="swatch-container">
                                {% for color_name, hex_code in unique_colors|dictsort:0 %}
                                <button type="button" 
                                        x-on:click="selectedColor = '{{ color_name }}'; findVariant();"
                                         class="color-swatch"
                                        :class="{ 'is-selected': selectedColor === '{{ color_name }}' }"
                                        style="background-color: {{ hex_code }}; {% if color_name == 'White' %}border: 1px solid #D1D5DB;{% endif %}"
                                        aria-label="Select color {{ color_name }}">
                                    
                                    <template x-if="selectedColor === '{{ color_name }}'">
                                         <svg class="checkmark-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 13.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                    </template>
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="option-group">
                            <h3 class="option-label">Size: 
                                <span class="option-value" x-text="selectedSize"></span>
                            </h3>
                            <div class="size-container">
                                {% for size_name in unique_sizes %}
                                <button type="button" 
                                        x-on:click="selectedSize = '{{ size_name }}'; findVariant();"
                                        class="size-option"
                                        :class="{ 'is-selected': selectedSize === '{{ size_name }}' }"
                                        aria-label="Select size {{ size_name }}">
                                    {{ size_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <input type="hidden" name="variant_id" :value="selectedVariantId">
                        <input type="hidden" id="base-url-input" value="{% url 'cart:add_to_cart' 0 %}">
                        
                        <div x-show="isInStock" x-transition style="margin-top: 1.5rem;">
                            <label for="quantity-input" class="option-label" style="font-size: 0.875rem;">Quantity:</label>
                            <input type="number" id="quantity-input" name="quantity" value="1" min="1" max="99" class="quantity-input" aria-label="Product quantity">
                        </div>

                        <button type="submit" 
                                :disabled="!isInStock || selectedVariantId === '0'" 
                                class="btn-add-to-cart"
                                :class="{ 'active': isInStock && selectedVariantId !== '0', 'disabled': !isInStock || selectedVariantId === '0' }"
                                aria-label="Add selected product to cart">
                            <span x-show="isInStock && selectedVariantId !== '0'">Add to Cart</span>
                            <span x-show="!isInStock || selectedVariantId === '0'">Out of Stock / Invalid Selection</span>
                        </button>
                    </form>
                </div>
                {% endwith %}
            {% else %}
                <p class="text-red-500 font-semibold mt-4">This product is currently unavailable or has no variants.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addToCartForm = document.getElementById('add-to-cart-form');
    // Guard clause in case form isn't present (e.g. no variants)
    if (!addToCartForm) return;

    const hiddenVariantIdInput = addToCartForm.querySelector('input[name="variant_id"]');
    const baseUrlInput = document.getElementById('base-url-input');

    function updateFormAction() {
        const selectedVariantId = hiddenVariantIdInput.value;
        const baseUrl = baseUrlInput.value;

        if (selectedVariantId && selectedVariantId !== '0') {
            addToCartForm.action = baseUrl.replace('0', selectedVariantId);
            return true;
        }
        return false;
    }

    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'value') {
                updateFormAction();
            }
        });
    });

    observer.observe(hiddenVariantIdInput, {
        attributes: true
    });

    addToCartForm.addEventListener('submit', function(event) {
        if (!updateFormAction()) {
            console.error('Invalid variant ID. Halting submission.');
            event.preventDefault();
        }
    });

    updateFormAction();
});
</script>
{% endblock %}