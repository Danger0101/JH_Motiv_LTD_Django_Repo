{% load static %} {% load unicorn %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>{% block title %}JH Motiv LTD{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

{% load static tailwind_tags %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- TailwindCSS for styling -->
    {% tailwind_css %}

    <!-- HTMX and Alpine.js -->
    <script
      src="https://unpkg.com/htmx.org@1.9.10"
      integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.13.7/dist/cdn.min.js"
      integrity="sha384-m4beazb0y1x4/6j9kQ+gX1e3y7rX7/3xXN6z5/6z5/6z5"
      crossorigin="anonymous"
    ></script>

    <style>
      /* Flexbox Sticky Footer */
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .content-wrapper {
        flex: 1 0 auto;
      }
      /* Simple transition for Alpine dropdown */
      [x-cloak] {
        display: none !important;
      }
      .transition-enter-active,
      .transition-leave-active {
        transition: opacity 0.3s ease;
      }
      .transition-enter-from,
      .transition-leave-to {
        opacity: 0;
      }
    </style>
        {% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/carousel.css' %}">
    {% endblock %}
  </head>
  <body
    class="bg-gray-100 text-gray-800"
    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
  >
    {% include 'partials/cookie_consent.html' %}

    <!-- Header -->
    {% include 'partials/navbar.html' %}

    <!-- Main Content -->
    <main class="content-wrapper">{% block content %}{% endblock %}</main>

    <!-- Footer -->
    {% include 'partials/footer.html' %} {% unicorn_scripts %}
    {% block extra_scripts %}
      <script src="{% static 'js/carousel.js' %}"></script>
      <script>
        // Alpine.js function for the recurring availability editor
        function scheduleEditor(initialScheduleJSON) {
            return {
                isSaving: false,
                message: '',
                isError: false,
                schedule: [],
                init() {
                    const initialSchedule = JSON.parse(initialScheduleJSON);
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    this.schedule = dayNames.map((name, index) => ({
                        name: name,
                        slots: initialSchedule[index] ? [...initialSchedule[index]] : []
                    }));
                },
                addSlot(dayIndex) {
                    this.schedule[dayIndex].slots.push({ start: '09:00', end: '17:00' });
                },
                removeSlot(dayIndex, slotIndex) {
                    this.schedule[dayIndex].slots.splice(slotIndex, 1);
                },
                async saveSchedule() {
                    this.isSaving = true;
                    this.message = '';
                    this.isError = false;

                    for (const day of this.schedule) {
                        const sortedSlots = [...day.slots].sort((a, b) => a.start.localeCompare(b.start));
                        for (let i = 0; i < sortedSlots.length - 1; i++) {
                            if (sortedSlots[i].end > sortedSlots[i+1].start) {
                                this.isError = true;
                                this.message = `Error on ${day.name}: Time slots cannot overlap.`;
                                this.isSaving = false;
                                return;
                            }
                        }
                    }

                    try {
                        const response = await fetch("{% url 'coaching:api_recurring_availability' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({ schedule: this.schedule })
                        });
                        const data = await response.json();
                        if (!response.ok) { throw new Error(data.error || 'An unknown error occurred.'); }
                        this.message = data.message;
                        htmx.trigger('body', 'recurring-schedule-updated');
                    } catch (error) {
                        this.isError = true;
                        this.message = error.message;
                    } finally {
                        this.isSaving = false;
                        setTimeout(() => this.message = '', 4000);
                    }
                }
            }
        }

        // Alpine.js function for the offering create/edit form
        function offeringManager() {
            return {
                isEditing: false,
                formData: { id: '', name: '', description: '', price: '', credits_granted: 1, duration_months: 3, is_active: true, is_full_day: false, duration_minutes: 60, terms_and_conditions: '', questions: [] },
                resetForm() {
                    this.isEditing = false;
                    this.formData = { id: '', name: '', description: '', price: '', credits_granted: 1, duration_months: 3, is_active: true, is_full_day: false, duration_minutes: 60, terms_and_conditions: '', questions: [] };
                },
                editOffering(offeringId) {
                    const dataScript = document.getElementById(`offering-data-${offeringId}`);
                    if (dataScript) {
                        const data = JSON.parse(dataScript.textContent);
                        this.isEditing = true;
                        this.formData = {
                            id: data.id,
                            name: data.name,
                            description: data.description,
                            price: data.price,
                            credits_granted: data.credits_granted,
                            duration_months: data.duration_months,
                            is_active: data.is_active,
                            is_full_day: data.is_full_day,
                            duration_minutes: data.duration_minutes,
                            terms_and_conditions: data.terms_and_conditions,
                            questions: data.questions.map(q => ({ text: q.text }))
                        };
                    }
                },
                addQuestion() {
                    this.formData.questions.push({ text: '' });
                },
                removeQuestion(index) {
                    this.formData.questions.splice(index, 1);
                }
            }
        }
      </script>
    {% endblock %}
  </body>
</html>
