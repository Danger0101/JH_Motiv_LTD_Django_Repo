{% extends "base.html" %}
{% load static %}
{% block title %}Coach Landing - {{ block.super }}{% endblock %}

{% block content %}
<div class="bg-gray-50">
    <div class="text-center py-16 px-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Find Your Path to Success</h1>
        <p class="mt-4 text-lg text-gray-600">Unlock your potential with our expert coaches.</p>
        <a href="#expert-coaches" class="mt-8 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300">
            Find a Coach
        </a>
    </div>

    <div id="expert-coaches" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            
            {% if user.is_authenticated %}
                <div class="mb-12 text-center" id="free-session-status-container">
                    {% with latest_offer=user.free_offers.all|first %}
                        {% if latest_offer and latest_offer.is_redeemed %}
                            <div class="p-4 bg-green-50 text-green-700 rounded-lg inline-block">
                                üéâ You have a taster session booked! Check your <a href="{% url 'accounts:account_profile' %}" class="underline font-bold">Profile</a>.
                            </div>
                        {% elif latest_offer and latest_offer.is_approved %}
                            <div class="p-4 bg-blue-50 text-blue-700 rounded-lg inline-block">
                                ‚úÖ Your taster session is approved! <a href="{% url 'accounts:account_profile' %}" class="underline font-bold">Book it now in your Profile</a>.
                            </div>
                        {% elif latest_offer %}
                            <div class="p-4 bg-yellow-50 text-yellow-700 rounded-lg inline-block">
                                ‚è≥ You have a pending request with {{ latest_offer.coach.user.get_full_name }}. Please wait for approval.
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            {% else %}
                <div class="mb-12 text-center">
                    <a href="{% url 'account_login' %}?next={% url 'coaching_booking:coach_landing' %}" class="inline-block px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition">
                        Login to Apply for a Free Taster Session
                    </a>
                </div>
            {% endif %}

            <h2 class="text-3xl font-bold text-center text-gray-800">Meet Our Expert Coaches</h2>
            <div class="mt-12 grid md:grid-cols-3 gap-8">
                {% for coach in coaches %}
                <div class="bg-gray-50 p-6 rounded-lg shadow-md text-center flex flex-col h-full">
                    {% if coach.public_photo %}
                        <img class="w-32 h-32 rounded-full mx-auto object-cover" src="{{ coach.public_photo.url }}" alt="{{ coach.user.get_full_name }}">
                    {% else %}
                        <img class="w-32 h-32 rounded-full mx-auto object-cover" src="{% static 'images/default_coach_avatar.png' %}" alt="Default Coach Avatar">
                    {% endif %}
                    
                    <h3 class="mt-4 text-xl font-bold text-gray-800">{{ coach.user.get_full_name }}</h3>
                    <p class="mt-2 text-gray-600 text-sm italic flex-grow">{{ coach.bio|truncatewords:20 }}</p>
                    
                    <div class="mt-6 space-y-3">
                        <a href="{% url 'coaching_booking:offer-list' %}?coach={{ coach.user.username }}" class="block w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                            View Paid Offers
                        </a>

                        {% if user.is_authenticated %}
                            {% with latest_offer=user.free_offers.all|first %}
                                {% if not latest_offer or latest_offer.is_expired %}
                                    <form hx-post="{% url 'coaching_booking:apply_for_free_session' %}" hx-swap="outerHTML" hx-target="#free-session-status-container">
                                        {% csrf_token %}
                                        <input type="hidden" name="coach_id" value="{{ coach.id }}">
                                        <button type="submit" class="block w-full py-2 px-4 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition shadow-sm">
                                            Apply for Taster
                                        </button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-gray-600 col-span-3">No active coaches are available at the moment.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}