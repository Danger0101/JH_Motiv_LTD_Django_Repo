<form id="recurring-form" hx-post="{% url 'coaching:api_recurring_availability' %}" hx-trigger="submit" hx-target="#form-message" hx-swap="innerHTML">
    {% csrf_token %}
    
    <div id="schedule-days-container" class="space-y-4">
    </div>

    <div id="form-message" class="mt-4"></div>

    <button type="submit" class="mt-6 bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 transition font-semibold">
        Save Weekly Schedule
    </button>
</form>

<script>
    (function() {
        const initialScheduleData = {{ schedule | safe }}; 
        const container = document.getElementById('schedule-days-container');
        const form = document.getElementById('recurring-form');
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        const scheduleMap = new Map();
        initialScheduleData.forEach(slot => {
            if (!scheduleMap.has(slot.day_of_week)) {
                scheduleMap.set(slot.day_of_week, []);
            }
            scheduleMap.get(slot.day_of_week).push(slot);
        });

        for (let i = 0; i < 7; i++) {
            const daySlots = scheduleMap.get(i) || [];
            const isAvailable = daySlots.length > 0 && daySlots[0].is_available;
            
            const dayDiv = document.createElement('div');
            dayDiv.className = 'flex items-center space-x-4 p-2 border-b last:border-b-0';
            
            dayDiv.innerHTML = `
                <input type="checkbox" id="day-${i}-check" data-day="${i}" class="day-checkbox h-5 w-5 text-indigo-600 rounded" ${isAvailable ? 'checked' : ''}>
                <label for="day-${i}-check" class="w-24 font-semibold">${dayNames[i]}</label>
                <div class="time-inputs flex flex-grow space-x-2 ${!isAvailable ? 'opacity-50 pointer-events-none' : ''}">
                    <input type="time" data-day="${i}" data-type="start" class="start-time-input p-1 border rounded w-1/2" value="${daySlots.length > 0 ? daySlots[0].start_time : '09:00'}">
                    <input type="time" data-day="${i}" data-type="end" class="end-time-input p-1 border rounded w-1/2" value="${daySlots.length > 0 ? daySlots[0].end_time : '17:00'}">
                </div>
            `;
            container.appendChild(dayDiv);

            dayDiv.querySelector('.day-checkbox').addEventListener('change', function() {
                const timeInputs = dayDiv.querySelector('.time-inputs');
                if (this.checked) {
                    timeInputs.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    timeInputs.classList.add('opacity-50', 'pointer-events-none');
                }
            });
        }

        form.addEventListener('htmx:configRequest', function(e) {
            e.detail.headers['Content-Type'] = 'application/json';
            
            const payload = [];
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                const day = parseInt(checkbox.dataset.day);
                const isChecked = checkbox.checked;
                const startInput = document.querySelector(`.start-time-input[data-day="${day}"]`);
                const endInput = document.querySelector(`.end-time-input[data-day="${day}"]`);

                payload.push({
                    day_of_week: day,
                    start_time: startInput.value,
                    end_time: endInput.value,
                    is_available: isChecked
                });
            });

            e.detail.parameters = JSON.stringify({ schedule: payload });
        });

        form.addEventListener('htmx:afterRequest', function(e) {
            if (e.detail.successful) {
                htmx.trigger('body', 'recurring-schedule-updated');
                htmx.find('#form-message').innerHTML = '<p class="text-green-600">Weekly Schedule Saved!</p>';
            } else {
                htmx.find('#form-message').innerHTML = '<p class="text-red-600">Error saving schedule.</p>';
            }
        });
    })();
</script>