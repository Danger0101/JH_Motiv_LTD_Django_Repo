<div class="availability-manager p-4 border rounded-lg bg-gray-50">
    
    <div class="text-gray-700 mb-3 text-sm">
        Your Timezone: <strong id="coach-timezone">{{ timezone }}</strong> 
    </div>
    <p class="text-xs text-gray-600 mb-4">Set the hours you are routinely available each week. This is the foundation of your schedule.</p>

    <form id="recurring-form" 
          hx-post="{% url 'coaching:api_recurring_availability' %}"
          hx-swap="none" 
          hx-on::after-request="if(event.detail.successful) { alert('Weekly Schedule Saved!'); htmx.trigger('#recurring-schedule-ui', 'load'); } else { alert('Error saving schedule: ' + event.detail.xhr.response); }">
        {% csrf_token %}
        
        <div id="schedule-days-container" class="space-y-4">
            </div>

        <button type="submit" class="mt-6 bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 transition font-semibold">
            Save Weekly Schedule
        </button>
    </form>

    <script>
        // --- JavaScript for Interactive Calendar UI ---
        const initialScheduleData = {{ schedule | safe }}; 
        const container = document.getElementById('schedule-days-container');
        const form = document.getElementById('recurring-form');
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Map the initial data for easy lookup
        const scheduleMap = new Map();
        initialScheduleData.forEach(slot => {
            if (!scheduleMap.has(slot.day_of_week)) {
                scheduleMap.set(slot.day_of_week, []);
            }
            scheduleMap.get(slot.day_of_week).push(slot);
        });

        // 1. Render the UI for all 7 days
        for (let i = 0; i < 7; i++) {
            const daySlots = scheduleMap.get(i) || [];
            const isAvailable = daySlots.length > 0 && daySlots[0].is_available;
            
            const dayDiv = document.createElement('div');
            dayDiv.className = 'flex items-center space-x-4 p-2 border-b last:border-b-0';
            
            dayDiv.innerHTML = `
                <input type="checkbox" id="day-${i}-check" data-day="${i}" class="day-checkbox h-5 w-5 text-indigo-600 rounded" ${isAvailable ? 'checked' : ''}>
                <label for="day-${i}-check" class="w-24 font-semibold">${dayNames[i]}</label>
                <div class="time-inputs flex flex-grow space-x-2 ${!isAvailable ? 'opacity-50 pointer-events-none' : ''}">
                    <input type="time" data-day="${i}" data-type="start" class="start-time-input p-1 border rounded w-1/2" value="${daySlots.length > 0 ? daySlots[0].start_time : '09:00'}">
                    <input type="time" data-day="${i}" data-type="end" class="end-time-input p-1 border rounded w-1/2" value="${daySlots.length > 0 ? daySlots[0].end_time : '17:00'}">
                </div>
            `;
            container.appendChild(dayDiv);

            // Toggle logic for checkbox
            dayDiv.querySelector('.day-checkbox').addEventListener('change', function() {
                const timeInputs = dayDiv.querySelector('.time-inputs');
                if (this.checked) {
                    timeInputs.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    timeInputs.classList.add('opacity-50', 'pointer-events-none');
                }
            });
        }

        // 2. Intercept form submission to build the JSON payload
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const payload = [];
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                const day = parseInt(checkbox.dataset.day);
                const isChecked = checkbox.checked;
                
                if (isChecked) {
                    const startInput = document.querySelector(`.start-time-input[data-day="${day}"]`);
                    const endInput = document.querySelector(`.end-time-input[data-day="${day}"]`);

                    if (startInput.value && endInput.value) {
                        payload.push({
                            day_of_week: day,
                            start_time: startInput.value,
                            end_time: endInput.value,
                            is_available: true
                        });
                    }
                }
            });

            // Send the JSON payload via HTMX
            htmx.ajax('POST', form.action, {
                // IMPORTANT: Send the CSRF token in the headers for JSON requests
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                // The form element itself is the target for receiving the successful status code
                target: form, 
                swap: 'none',
                // Pass the custom JSON body
                json: { schedule: payload } 
            });
        });
    </script>
</div>