{% load static %}
{% load socialaccount %} 

{# This partial now renders COMPLETELY different content based on auth status for a better UX #}

{% if request.user.is_authenticated %}
    {# === AUTHENTICATED USER: One-Click Application Form === #}
    <form method="post" action="{% url 'coaching_client:taster_request' %}" id="taster-request-form">
        {% csrf_token %}
        <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="tasterModalLabel">Request Your Free Taster Session ðŸš€</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <p class="mb-3">You're logged in! We'll use your profile details for a quick, one-click application.</p>
            
            <div class="card p-3 bg-light border">
                <div class="d-flex align-items-center">
                    {% get_social_accounts request.user as social_accounts %}
                    {% with social_accounts.google.0.get_avatar_url as avatar_url %}
                        {% if avatar_url %}
                            <img src="{{ avatar_url }}" alt="Your avatar" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                        {% else %}
                            <div class="rounded-circle me-3 bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <span class="fw-bold fs-5">{{ request.user.email.0|upper }}</span>
                            </div>
                        {% endif %}
                    {% endwith %}
                    <div>
                        <strong class="d-block">{{ request.user.get_full_name }}</strong>
                        <small class="text-muted">{{ request.user.email }}</small>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="goal_summary" value="User submitted a one-click taster session request via the coach page. Goals to be determined in the first contact." />
            <p class="text-muted small mt-3">Click 'Submit Request' to confirm. We'll contact you via email within 24 hours.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success" id="submit-taster-btn">
                <i class="fas fa-paper-plane me-2"></i>Submit Request
            </button>
        </div>
    </form>
    <script>
        // JS to prevent double submission
        document.getElementById('taster-request-form').addEventListener('submit', function(event) {
            var submitBtn = document.getElementById('submit-taster-btn');
            if (submitBtn.disabled) {
                event.preventDefault();
                return;
            }
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
        });
    </script>

{% else %}
    {# === GUEST USER: Login/Signup Prompt === #}
    <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="tasterModalLabel">Get Your Free Taster Session</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body text-center py-4">
        <i class="fas fa-lock fa-3x text-primary mb-3"></i>
        <h4 class="mb-3">Log In to Continue</h4>
        <p class="text-muted">To request your free session, please log in or create an account. It's quick and ensures we can manage your request properly.</p>
        
        <div class="mt-4">
            <a href="{% provider_login_url 'google' %}?next={{ request.path }}" class="btn btn-outline-dark w-100 mb-2">
                <img src="{% static 'images/google-logo.svg' %}" alt="Google logo" style="width: 20px; height: 20px;" class="me-2">
                Continue with Google
            </a>
            <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-primary w-100 mb-2">
                <i class="fas fa-envelope me-2"></i>Log In with Email
            </a>
            <p class="text-muted small mt-3">
                New here? <a href="{% url 'account_signup' %}?next={{ request.path }}">Create an Account</a>
            </p>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    </div>
{% endif %}