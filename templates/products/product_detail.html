{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Shop{% endblock %}

{% block extra_head %}
{{ block.super }}
<style nonce="{{ csp_nonce }}">
    @keyframes lootShake {
        0% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-5px, 5px) rotate(-5deg); }
        50% { transform: translate(5px, -5px) rotate(5deg); }
        75% { transform: translate(-5px, 5px) rotate(-5deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }
    .animate-loot-shake {
        animation: lootShake 0.5s ease-in-out infinite;
    }
    .loot-rays {
        background: repeating-conic-gradient(
            from 0deg,
            rgba(255, 215, 0, 0.1) 0deg 20deg,
            transparent 20deg 40deg
        );
        animation: spin 10s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .text-shadow-loot {
        text-shadow: 2px 2px 0 #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="lootBox">
    
    {# --- LOOT BOX MODAL --- #}
    <div x-show="show" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-90" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div class="bg-gray-900 border-4 border-yellow-500 p-8 rounded-2xl shadow-2xl text-center relative overflow-hidden max-w-sm w-full mx-4">
            <div class="absolute inset-0 loot-rays"></div>
            <div class="relative z-10">
                <div class="text-6xl mb-4 animate-loot-shake inline-block">üéÅ</div>
                <h2 class="text-3xl font-black text-white uppercase tracking-widest mb-2 text-shadow-loot">Loot Stashed!</h2>
                <p class="text-yellow-400 font-mono text-sm">Item added to loadout.</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
        
        <div role="region" aria-label="Product Image" class="relative">
            <img src="{% if product.featured_image %}{{ product.featured_image.url }}{% else %}https://via.placeholder.com/500{% endif %}" 
                 alt="{{ product.name }}" 
                 class="w-full rounded-lg shadow-xl aspect-square object-contain bg-gray-50">
            {% if is_sold_out %}
                <span class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-full font-bold shadow-lg transform rotate-12 z-10">
                    SOLD OUT
                </span>
            {% endif %}
        </div>

        <div>
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">{{ product.name }}</h1>
            
            {# --- DICE RATING --- #}
            {% if product.dice_rating > 0 %}
            <div class="flex items-center mb-4 text-yellow-500" title="Difficulty Rating: {{ product.dice_rating }}/5">
                {% for i in filled_dice %}
                    <span class="text-2xl mr-1">üé≤</span> 
                {% endfor %}
                {% for i in empty_dice %}
                    <span class="text-2xl mr-1 opacity-30">üé≤</span>
                {% endfor %}
                <span class="text-gray-600 text-sm ml-2 font-medium">({{ product.dice_rating }}/5 Difficulty)</span>
            </div>
            {% endif %}

            <p class="text-gray-600 mb-6">{{ product.description }}</p>

            {% if product.variants.all %}
                {% with first_variant=product.variants.first %}
                
                <div x-data="productVariantSelector">
                    
                    <div class="mb-6 flex items-center gap-4">
                        <span class="text-4xl font-extrabold text-gray-900" x-text="formattedPrice">
                            ¬£{{ first_variant.price|floatformat:2 }}
                        </span>
                        {% if product.shipping_included %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 shadow-sm">
                                Free UK/EU Shipping
                            </span>
                        {% endif %}
                    </div>

                    {# --- PREORDER ALERT --- #}
                    {% if product.is_preorder %}
                        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-r shadow-sm" role="alert">
                            <p class="font-bold flex items-center"><span class="text-xl mr-2">‚è≥</span> Preorder Item</p>
                            <p class="mt-1">Expected Release: <span class="font-semibold">{{ product.preorder_release_date|default:"Coming Soon" }}</span></p>
                        </div>
                    {% endif %}

                    <form x-ref="addToCartForm"
                          method="post"
                          class="space-y-8"
                          hx-post="{% url 'core:add_to_cart' product.id %}"
                          hx-trigger="confirmed-add-to-cart"
                          hx-indicator="#add-to-cart-spinner"
                          @htmx:after-request="handleAfterRequest"
                          x-on:submit.prevent="addToCart"
                          >
                        {% csrf_token %}
                        
                        {% if show_color_selector %}
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-gray-800">Skin <span class="text-sm text-gray-500 font-normal">(Color)</span>: 
                                <span class="font-bold" x-text="selectedColor"></span>
                            </h3>
                            <div class="flex flex-wrap gap-3">
                                {% for color_name, hex_code in unique_colors %}
                                <button type="button" 
                                        x-data="colorButton"
                                        data-color="{{ color_name|escapejs }}"
                                        data-hex="{{ hex_code }}"
                                        x-on:click="select"
                                        class="w-10 h-10 rounded-full border-2 transition-all duration-150 relative group"
                                        :class="classes"
                                        :style="style"
                                        aria-label="Select color {{ color_name }}"
                                        title="{{ color_name }}">
                                    
                                    <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-900 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-20 shadow-lg">
                                        {{ color_name }}
                                    </span>
                                    <svg x-show="isSelected" class="w-4 h-4 text-white absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 13.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if show_size_selector %}
                        <div class="space-y-3">
                            <h3 class="text-lg font-semibold text-gray-800">Size: 
                                <span class="font-bold" x-text="selectedSize"></span>
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                {% for size_name in unique_sizes %}
                                <button type="button" 
                                        x-data="sizeButton"
                                        data-size="{{ size_name|escapejs }}"
                                        x-on:click="select"
                                        class="px-5 py-2 border-2 rounded-xl cursor-pointer text-sm font-medium transition duration-150 ease-in-out shadow-sm"
                                        :class="classes"
                                        aria-label="Select size {{ size_name }}">
                                    {{ size_name }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <input type="hidden" name="variant_id" :value="selectedVariantId">
                        <input type="hidden" name="size" :value="selectedSize">
                        <input type="hidden" name="color" :value="selectedColor">
                        <input type="hidden" id="base-url-input" value="{% url 'core:add_to_cart' product.id %}">
                        
                        <div x-show="isInStock" x-transition>
                            <label for="quantity-input" class="block text-sm font-medium text-gray-700">Quantity:</label>
                            <input type="number" id="quantity-input" name="quantity" value="1" min="1" max="99" class="mt-1 block w-full max-w-xs pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" aria-label="Product quantity">
                        </div>

                        <div class="relative">
                            <button type="submit" 
                                    :disabled="isAddToCartDisabled" 
                                    :class="addToCartClasses"
                                    class="w-full text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:-translate-y-0.5 flex items-center justify-center" 
                                    aria-label="Add selected product to cart"
                                    title="Add to Shopping Cart">
                                <span id="add-to-cart-spinner" class="htmx-indicator animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></span>
                                <span x-show="showAddText" x-text="addTextLabel">Add to Stash</span>
                                <span x-show="showSoldOutText">SOLD OUT</span>
                                <span x-show="showDepletedText">Loot Depleted / Invalid Selection</span>
                            </button>
                        </div>
                    </form>
                </div>
                {% endwith %}
            {% else %}
                <p class="text-red-500 font-semibold mt-4">This product is currently unavailable or has no variants.</p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script nonce="{{ csp_nonce }}" defer>
    document.addEventListener('alpine:init', () => {
        // Loot Box Component
        Alpine.data('lootBox', () => ({
            show: false,
            init() {
                window.addEventListener('loot-acquired', () => {
                    this.show = true;
                    setTimeout(() => this.show = false, 3000);
                });
            }
        }));

        // Product Variant Selector Component
        Alpine.data('productVariantSelector', () => ({
            selectedColor: '{{ initial_color|escapejs }}',
            selectedSize: '{{ initial_size|escapejs }}',
            selectedVariantId: '{{ product.variants.first.id|default:'0' }}',
            currentPrice: '{{ product.variants.first.price|floatformat:2|default:'0.00' }}',
            isInStock: true,
            isSoldOut: {{ is_sold_out|yesno:"true,false" }},
            isPreorder: {{ product.is_preorder|yesno:'true,false' }},
            variantMap: JSON.parse('{{ variant_lookup_json|escapejs }}'),

            init() {
                console.log('Variant Map Loaded:', this.variantMap);
                
                // FIX: Handle single-variant products (like books) that have no size/color options
                const keys = Object.keys(this.variantMap);
                if (keys.length === 1) {
                    const data = this.variantMap[keys[0]];
                    this.selectedColor = data.color;
                    this.selectedSize = data.size;
                }
                
                this.findVariant();

                // Fallback: If initial selection failed (e.g. single variant mismatch), pick the first one
                if (this.selectedVariantId === '0' && keys.length > 0) {
                    const data = this.variantMap[keys[0]];
                    this.selectedColor = data.color;
                    this.selectedSize = data.size;
                    this.findVariant();
                }
            },

            get formattedPrice() {
                return '¬£' + this.currentPrice;
            },

            findVariant() {
                const key = this.selectedColor + '_' + this.selectedSize;
                const data = this.variantMap[key] || null;
                if (data) {
                    this.selectedVariantId = data.id;
                    this.currentPrice = data.price.toFixed(2);
                    this.isInStock = data.in_stock;
                } else {
                    this.selectedVariantId = '0';
                    this.isInStock = false;
                }
            },

            get isAddToCartDisabled() {
                return this.isSoldOut || !this.isInStock || this.selectedVariantId === '0';
            },
            get addToCartClasses() {
                return !this.isAddToCartDisabled
                    ? 'bg-blue-600 hover:bg-blue-700'
                    : 'bg-gray-400 cursor-not-allowed';
            },
            get showAddText() {
                return !this.isSoldOut && this.isInStock && this.selectedVariantId !== '0';
            },
            get showSoldOutText() {
                return this.isSoldOut;
            },
            get showDepletedText() {
                return !this.isSoldOut && (!this.isInStock || this.selectedVariantId === '0');
            },
            get addTextLabel() {
                return this.isPreorder ? 'Preorder Now' : 'Add to Stash';
            },
            handleAfterRequest(event) {
                if (event.detail.successful) {
                    this.$dispatch('loot-acquired');
                }
            },

            addToCart() {
                const form = this.$refs.addToCartForm;
                const variantId = this.selectedVariantId;
                if (variantId && variantId !== '0') {
                    htmx.process(form);
                    form.dispatchEvent(new Event('confirmed-add-to-cart', {bubbles: true}));
                } else {
                    console.error('Invalid variant ID');
                }
            }
        }));

        // Color Button Component
        Alpine.data('colorButton', () => ({
            color: '',
            hex: '',
            init() {
                this.color = this.$el.getAttribute('data-color');
                this.hex = this.$el.getAttribute('data-hex');
            },
            get isSelected() {
                return this.selectedColor === this.color;
            },
            get classes() {
                return this.isSelected 
                    ? 'ring-4 ring-offset-2 ring-blue-500 border-transparent' 
                    : 'border-gray-300 hover:border-blue-400';
            },
            get style() {
                let style = { backgroundColor: this.hex };
                if (this.color === 'White') {
                    style.border = '1px solid #D1D5DB';
                }
                return style;
            },
            select() {
                this.selectedColor = this.color;
                this.findVariant();
            }
        }));

        // Size Button Component
        Alpine.data('sizeButton', () => ({
            size: '',
            init() {
                this.size = this.$el.getAttribute('data-size');
            },
            get isSelected() {
                return this.selectedSize === this.size;
            },
            get classes() {
                return this.isSelected
                    ? 'bg-blue-600 text-white border-blue-600'
                    : 'bg-white text-gray-700 border-gray-300 hover:border-blue-300';
            },
            select() {
                this.selectedSize = this.size;
                this.findVariant();
            }
        }));
    });
</script>
{% endblock %}