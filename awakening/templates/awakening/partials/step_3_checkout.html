<div class="w-full max-w-md mx-auto">
    <div class="bg-black border border-green-900 p-6 mb-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-green-500 animate-pulse"></div>
        <h3 class="text-xl font-bold text-white mb-4">SECURE TRANSACTION UPLINK</h3>
        
        <div class="flex items-center justify-between mb-4 text-sm font-mono text-gray-400 border-b border-gray-800 pb-2">
            <span>ITEM:</span>
            <span class="text-white">{{ variant.product.name }} (x{{ quantity }})</span>
        </div>
        
        <div class="flex items-center justify-between mb-6 text-sm font-mono text-gray-400 border-b border-gray-800 pb-2">
            <span>DISTRIBUTION:</span>
            <span class="text-white">KEEP: {{ keep_count }} | DONATE: {{ quantity|add:"-1" }}</span>
        </div>

        {# --- ORDER BUMP --- #}
        {% if order_bumps %}
        <div class="mb-6 p-4 border border-yellow-700 bg-yellow-900/10" x-data="{ bumped: false }">
            {% with bump=order_bumps.0 %}
            <label class="flex items-start cursor-pointer">
                <input type="checkbox" id="bump-offer" class="mt-1 mr-3" x-model="bumped" @change="$dispatch('bump-change', { active: bumped, price: {{ bump.variant.price }} })">
                <div>
                    <div class="text-yellow-400 font-bold text-sm">{{ bump.headline }}</div>
                    <div class="text-gray-300 text-xs mt-1">{{ bump.name }} (+£{{ bump.variant.price }})</div>
                </div>
            </label>
            {% endwith %}
        </div>
        {% endif %}

        <div class="flex items-center justify-between mb-8 text-2xl font-bold font-mono text-green-400">
            <span>TOTAL:</span>
            <span x-data="{ total: {{ total }}, bumpPrice: 0 }" 
                  @bump-change.window="if($event.detail.active) total += $event.detail.price; else total -= $event.detail.price;">
                £<span x-text="total.toFixed(2)"></span>
            </span>
        </div>

        {# --- STRIPE ELEMENTS FORM --- #}
        <form id="payment-form">
            <div id="link-authentication-element" class="mb-4"></div>
            <div id="payment-element" class="mb-4"></div>
            
            <button id="submit" class="w-full bg-green-600 text-black font-bold py-3 hover:bg-green-500 transition-colors relative group">
                <span id="button-text">INITIALIZE TRANSFER</span>
                <div id="spinner" class="hidden absolute inset-0 flex items-center justify-center bg-green-600">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-black"></div>
                </div>
            </button>
            <div id="payment-message" class="hidden mt-4 text-red-500 text-sm text-center"></div>
        </form>
    </div>
</div>

<!-- Stripe & local JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const stripe = Stripe("{{ stripe_public_key }}");
        const variantId = {{ variant.id }};
        const quantity = {{ quantity }};
        const keepCount = {{ keep_count }};
        
        // Prepare initial PaymentIntent
        let elements;
        let bumpVariantId = null;

        async function initialize() {
            // Check for bump
            const bumpCheckbox = document.getElementById('bump-offer');
            if (bumpCheckbox && bumpCheckbox.checked) {
                // Assuming logic to get ID if needed, using safe default if missing
                {% if order_bumps %}
                bumpVariantId = "{{ order_bumps.0.variant.id }}";
                {% endif %}
            }

            const response = await fetch("{% url 'awakening:create_payment_intent' %}", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ 
                    variant_id: variantId, 
                    quantity: quantity,
                    keep_count: keepCount,
                    bump_variant_id: bumpVariantId
                }),
            });
            
            const { clientSecret } = await response.json();

            const appearance = {
                theme: 'night',
                variables: { colorPrimary: '#00ff41', colorBackground: '#000000', colorText: '#ffffff' }
            };
            
            elements = stripe.elements({ appearance, clientSecret });
            const linkAuthenticationElement = elements.create("linkAuthentication");
            linkAuthenticationElement.mount("#link-authentication-element");
            const paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");
        }

        await initialize();

        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true);

            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                redirect: "if_required"
            });

            if (error) {
                showMessage(error.message);
                setLoading(false);
            } else if (paymentIntent && paymentIntent.status === "succeeded") {
                // Payment succeeded, create order
                
                const response = await fetch("{% url 'awakening:create_order' %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        payment_intent_id: paymentIntent.id,
                        variant_id: variantId,
                        quantity: quantity,
                        keep_count: keepCount,
                        bump_variant_id: bumpVariantId,
                        // If using Link, email is stored in Stripe, but passing explicit email is safer if you have an input
                        // For this snippet we assume user is logged in or we extract from context if needed
                        email: "guest@example.com", // Placeholder: In prod, get this from the Link element or user session
                        name: "Guest Agent"
                    })
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirect_url;
                } else {
                    showMessage("Order creation failed. Please contact support.");
                }
            }
        }

        document.getElementById("payment-form").addEventListener("submit", handleSubmit);

        function setLoading(isLoading) {
            if (isLoading) {
                document.querySelector("#submit").disabled = true;
                document.querySelector("#spinner").classList.remove("hidden");
                document.querySelector("#button-text").classList.add("hidden");
            } else {
                document.querySelector("#submit").disabled = false;
                document.querySelector("#spinner").classList.add("hidden");
                document.querySelector("#button-text").classList.remove("hidden");
            }
        }

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.classList.remove("hidden");
            messageContainer.textContent = messageText;
            setTimeout(function () {
                messageContainer.classList.add("hidden");
                messageContainer.textContent = "";
            }, 4000);
        }
    });
</script>