{% load static %}
{% url 'coaching_client:taster_request' as taster_request_url %}

<div class="modal-header">
    <h5 class="modal-title" id="tasterModalLabel">Request Your Free Taster Session ðŸš€</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form method="post" action="{{ taster_request_url }}" id="taster-request-form">
    <div class="modal-body">
        {% csrf_token %}
        
        {% if request.user.is_authenticated %}
            {# State: Logged In, Ready for One-Click Submit #}
            <div class="alert alert-success py-2">
                We're ready to submit your request instantly using your profile details:
                <br>
                <strong>Name:</strong> {{ request.user.get_full_name }}
                <br>
                <strong>Email:</strong> {{ request.user.email }}
            </div>
            
            <input type="hidden" 
                   name="goal_summary" 
                   value="User submitted a one-click taster session request via the coach page. Goals to be determined in the first contact." />

            <p class="text-muted small">Click 'Submit Request' to confirm. We will contact you via email within 24 hours.</p>

        {% else %}
            {# State: Logged Out - Show Manual Form Fields #}
            <div class="alert alert-info">
                Please fill out your details below to submit your request.
            </div>
            
            {# NOTE: This assumes your Django view passes the form object as 'form' #}
            {% if form %}
                <div class="space-y-4">
                    {{ form.full_name }}
                    {{ form.email }}
                    {{ form.phone_number }}
                    {{ form.goal_summary }}
                </div>
                {# Manual display of errors for the form fields #}
                {% for field in form %}
                    {% for error in field.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                    {% endfor %}
                {% endfor %}
                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        <p class="mt-2 text-sm text-red-600">{{ error }}</p>
                    {% endfor %}
                {% endif %}
            {% else %}
                 <p class="text-danger">Error: Form fields could not be loaded. Please ensure a 'form' object is passed to this template.</p>
            {% endif %}

        {% endif %}

    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        
        {% if request.user.is_authenticated or form %}
            {# Submit button for both logged-in (one-click) AND logged-out (manual form) users #}
            <button type="submit" class="btn btn-primary" id="submit-taster-btn">Submit Request</button>
        {% else %}
            <a href="{% url 'account_login' %}" class="btn btn-primary">Go to Login</a>
        {% endif %}
    </div>
</form>

<script>
    // Simple JS to prevent double submission
    document.getElementById('taster-request-form').addEventListener('submit', function() {
        this.querySelector('#submit-taster-btn').disabled = true;
        this.querySelector('#submit-taster-btn').textContent = 'Submitting...';
    });
</script>