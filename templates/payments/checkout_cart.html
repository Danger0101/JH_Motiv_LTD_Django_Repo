{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8">Secure Checkout</h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            
            <div class="order-2 lg:order-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Order Summary</h2>
                    
                    <div class="space-y-4 mb-6 max-h-96 overflow-y-auto pr-2">
                        {% for item in cart.items.all %}
                        <div class="flex gap-4">
                            <div class="h-16 w-16 flex-shrink-0 overflow-hidden rounded-md border border-gray-200">
                                {% if item.variant.product.featured_image %}
                                <img src="{{ item.variant.product.featured_image.url }}" class="h-full w-full object-cover">
                                {% else %}
                                <div class="h-full w-full bg-gray-200"></div>
                                {% endif %}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between text-base font-medium text-gray-900">
                                    <h3>{{ item.variant.product.name }}</h3>
                                    <p>£{{ item.get_total_price }}</p>
                                </div>
                                <p class="text-sm text-gray-500">{{ item.variant.name }} x {{ item.quantity }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if summary.discount_amount > 0 %}
                    <div class="flex justify-between py-2 text-green-600 border-t border-gray-100">
                        <span>Discount ({{ summary.coupon.code }})</span>
                        <span>-£{{ summary.discount_amount }}</span>
                    </div>
                    {% endif %}

                    <div class="border-t border-gray-200 pt-4 space-y-2">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span>£{{ summary.total }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Estimated Tax</span>
                            <span id="display-tax">--</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Shipping</span>
                            <span id="display-shipping">Calculated next</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-900 pt-4 border-t">
                            <span>Total</span>
                            <span id="display-total">£{{ summary.total }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-1 lg:order-2">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-indigo-50">
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Shipping Details</h3>
                        <div id="address-element"></div>
                    </div>

                    <div id="shipping-section" class="hidden mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Shipping Method</h3>
                        <div id="shipping-options" class="space-y-2"></div>
                    </div>

                    <div id="payment-section" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Payment</h3>
                        <div id="payment-element" class="mb-6"></div>
                        
                        <button id="submit-button" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition shadow-lg disabled:opacity-50">
                            <span id="button-text">Pay Now</span>
                            <div id="spinner" class="hidden inline-block animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                        </button>
                    </div>

                    <div id="error-message" class="hidden mt-4 text-red-600 text-sm"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
    const elements = stripe.elements({
        clientSecret: "{{ client_secret }}",
        appearance: { theme: 'stripe' },
        loader: 'auto'
    });

    // Create Address Element - Enables Autofill
    const addressElement = elements.create("address", { mode: "shipping", allowedCountries: ['GB', 'US'] });
    const paymentElement = elements.create("payment");
    
    addressElement.mount("#address-element");
    paymentElement.mount("#payment-element");

    let currentTax = 0;

    // Listen for valid address to trigger backend calculation
    addressElement.on('change', async (event) => {
        if (event.complete) {
            const address = event.value.address;
            
            document.getElementById('shipping-section').classList.remove('hidden');
            document.getElementById('shipping-options').innerHTML = '<div class="text-sm text-gray-500 animate-pulse">Calculating rates...</div>';

            try {
                const response = await fetch("{% url 'payments:checkout_calculate_fees' %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({ address: address })
                });
                
                const data = await response.json();
                currentTax = parseFloat(data.tax_amount);
                document.getElementById('display-tax').innerText = `£${data.tax_amount}`;
                
                if (data.rates.length > 0) {
                    let html = '';
                    data.rates.forEach((rate, index) => {
                        const isChecked = index === 0 ? 'checked' : '';
                        html += `
                        <label class="flex justify-between items-center p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-colors">
                            <div class="flex items-center">
                                <input type="radio" name="shipping_rate" value="${rate.amount}" 
                                       data-total="${rate.new_total}" ${isChecked}
                                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                                       onchange="updateTotal(this.value, this.dataset.total)">
                                <div class="ml-3">
                                    <span class="block text-sm font-medium text-gray-900">${rate.label}</span>
                                    <span class="block text-xs text-gray-500">${rate.detail}</span>
                                </div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">£${rate.amount}</span>
                        </label>`;
                    });
                    document.getElementById('shipping-options').innerHTML = html;
                    
                    // Select first rate by default
                    updateTotal(data.rates[0].amount, data.rates[0].new_total);
                    document.getElementById('payment-section').classList.remove('hidden');
                } else {
                    document.getElementById('shipping-options').innerHTML = '<p class="text-red-500">No shipping available.</p>';
                }

            } catch (e) {
                console.error(e);
            }
        }
    });

    async function updateTotal(shippingCost, newTotal) {
        document.getElementById('display-shipping').innerText = `£${shippingCost}`;
        document.getElementById('display-total').innerText = `£${newTotal}`;
        
        // Notify backend to update the PaymentIntent amount
        await fetch("{% url 'payments:checkout_update_total' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ 
                payment_intent_id: "{{ payment_intent_id }}",
                shipping_cost: shippingCost,
                tax_cost: currentTax
            })
        });
    }

    document.getElementById("submit-button").addEventListener("click", async (e) => {
        e.preventDefault();
        setLoading(true);

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: "{{ request.scheme }}://{{ request.get_host }}{% url 'payments:payment_success' %}?payment_intent={{ payment_intent_id }}",
            },
        });

        if (error) {
            const msg = document.getElementById("error-message");
            msg.innerText = error.message;
            msg.classList.remove('hidden');
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        document.getElementById("submit-button").disabled = isLoading;
        document.getElementById("spinner").classList.toggle("hidden", !isLoading);
        document.getElementById("button-text").classList.toggle("hidden", isLoading);
    }
</script>
{% endblock %}