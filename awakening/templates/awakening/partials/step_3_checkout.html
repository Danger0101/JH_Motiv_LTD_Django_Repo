{% comment %}
    STEP 3: CHECKOUT
    This template is loaded via HTMX when a user selects a tier.
    It includes the Stripe payment form and the new Order Bump functionality.
{% endcomment %}
<div id="checkout-form-container" class="w-full max-w-2xl mx-auto p-6 bg-gray-900 border border-gray-700 rounded-lg shadow-lg text-gray-200 font-mono">

    <!-- Order Summary -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-green-400 mb-4 border-b border-green-800 pb-2">&gt; SECURE CHECKOUT_</h2>
        <div class="flex justify-between items-center">
            <p class="text-lg">{{ variant.product.name }} (x{{ quantity }})</p>
            <p class="text-lg">£<span id="base-price" data-price="{{ total }}">{{ total|floatformat:2 }}</span></p>
        </div>
    </div>

    <!-- FINAL OFFER (Order Bump) -->
    {% if order_bumps %}
    <div id="order-bump-section" class="mb-6 p-4 border border-yellow-500 rounded-lg bg-gray-800/50">
        <h3 class="text-xl font-bold text-yellow-400 mb-3">{{ order_bumps.0.headline|default:"ONE-TIME OFFER: Upgrade Your Arsenal!" }}</h3>
        <div class="space-y-2">
            {% for bump in order_bumps %}
            <label for="bump-{{ bump.variant.id }}" class="flex items-center p-3 rounded-md bg-gray-900 hover:bg-gray-700 cursor-pointer transition-colors duration-200">
                <input type="radio"
                       id="bump-{{ bump.variant.id }}"
                       name="order_bump"
                       value="{{ bump.variant.id }}"
                       class="order-bump-radio h-4 w-4 text-yellow-500 bg-gray-700 border-gray-600 focus:ring-yellow-600"
                       data-price="{{ bump.variant.price }}"
                       {% if bump.is_default_choice %}checked{% endif %}>
                <span class="ml-3 text-gray-300">
                    <strong>{{ bump.name }}:</strong> Add "{{ bump.variant.name }}" for +£{{ bump.variant.price|floatformat:2 }}
                </span>
            </label>
            {% endfor %}
            <!-- No Thanks Option -->
            <label for="bump-none" class="flex items-center p-3 rounded-md bg-gray-900 hover:bg-gray-700 cursor-pointer transition-colors duration-200">
                <input type="radio"
                       id="bump-none"
                       name="order_bump"
                       value=""
                       class="order-bump-radio h-4 w-4 text-gray-500 bg-gray-700 border-gray-600 focus:ring-gray-600"
                       data-price="0"
                       {% if not order_bumps|slice:":1"|first.is_default_choice and not order_bumps|slice:"1:2"|first.is_default_choice %}checked{% endif %}>
                <span class="ml-3 text-gray-400">No thanks, I'll stick with the original offer.</span>
            </label>
        </div>
    </div>
    {% endif %}

    <!-- Total Price Display -->
    <div class="text-right text-2xl font-bold mb-6">
        <span class="text-gray-400">TOTAL:</span>
        <span id="total-price-display" class="text-green-400">£{{ total|floatformat:2 }}</span>
    </div>

    <!-- Stripe Payment Form -->
    <form id="payment-form" class="space-y-4">
        <div id="payment-element">
            <!-- Stripe.js injects the Payment Element here -->
        </div>
        <button id="submit-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 disabled:opacity-50">
            <span id="button-text">PAY NOW</span>
            <span id="spinner" class="hidden">Processing...</span>
        </button>
        <div id="payment-message" class="hidden text-center text-red-400 pt-2"></div>
    </form>
</div>

<!-- Stripe & local JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stripe = Stripe("{{ stripe_public_key }}");

    // --- State Management ---
    let elements;
    const variantId = "{{ variant.id }}";
    const quantity = "{{ quantity }}";
    const basePrice = parseFloat(document.getElementById('base-price').dataset.price);

    // --- Order Bump Logic ---
    const bumpRadios = document.querySelectorAll('.order-bump-radio');
    const totalPriceDisplay = document.getElementById('total-price-display');

    function getSelectedBump() {
        const selectedRadio = document.querySelector('.order-bump-radio:checked');
        return {
            id: selectedRadio ? selectedRadio.value : "",
            price: selectedRadio ? parseFloat(selectedRadio.dataset.price) : 0
        };
    }

    function updateTotalPrice() {
        const bump = getSelectedBump();
        const newTotal = basePrice + bump.price;
        totalPriceDisplay.textContent = `£${newTotal.toFixed(2)}`;
    }

    bumpRadios.forEach(radio => {
        radio.addEventListener('change', updateTotalPrice);
    });

    // Initialize total price on load
    updateTotalPrice();

    // --- Stripe Payment Intent & Form Handling ---
    initialize();

    async function initialize() {
        const selectedBump = getSelectedBump();
        const response = await fetch("{% url 'awakening:create_payment_intent' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                variant_id: variantId,
                quantity: quantity,
                bump_variant_id: selectedBump.id // Pass the selected bump ID
            }),
        });
        const { client_secret } = await response.json();

        elements = stripe.elements({ clientSecret: client_secret });
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");
    }

    document.getElementById('payment-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        setLoading(true);

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                // We don't need a return_url here because we handle the redirect manually
                // after creating the order in our backend.
            },
            redirect: "if_required" // IMPORTANT: Prevents automatic redirect
        });

        if (error) {
            if (error.type === "card_error" || error.type === "validation_error") {
                showMessage(error.message);
            } else {
                showMessage("An unexpected error occurred.");
            }
            setLoading(false);
        } else {
            // Payment succeeded, now create the order on our backend
            // This logic should be in your main payment success handler
            // For this funnel, we assume it's handled by the parent page listening for Stripe success.
            // If not, you would call your `create_order` endpoint here.
        }
    });

    // --- UI Helper Functions ---
    function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");
        messageContainer.classList.remove("hidden");
        messageContainer.textContent = messageText;
        setTimeout(() => { messageContainer.classList.add("hidden"); }, 4000);
    }

    function setLoading(isLoading) {
        document.querySelector("#submit-button").disabled = isLoading;
        document.querySelector("#spinner").classList.toggle("hidden", !isLoading);
        document.querySelector("#button-text").classList.toggle("hidden", isLoading);
    }
});
</script>