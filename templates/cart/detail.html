{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="cart-page-wrapper">
    <div class="cart-container">
        
        <header class="cart-header">
            <h1>Checkout</h1>
        </header>

        {% if not cart.items.exists %}
            <div class="empty-cart">
                <p style="font-size: 1.25rem; color: var(--gray-600); margin-bottom: 1.5rem;">Your cart is currently empty.</p>
                <a href="{% url 'products:product_list' %}" class="btn-start-shopping">Start Shopping</a>
            </div>
        {% else %}
            <div class="checkout-grid">
                
                <div class="items-col content-card">
                    <h2 class="card-title">Order Items</h2>
                    
                    <div id="cart-item-list" 
                         hx-trigger="load, cartUpdated from:body" 
                         hx-get="{% url 'cart:cart_item_list' %}" 
                         hx-target="this">
                        {% include 'cart/partials/cart_item_list.html' %}
                    </div>

                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-100);">
                        <a href="{% url 'products:product_list' %}" style="color: #2563eb; font-weight: 500; display: flex; align-items: center;">
                            ← Continue Shopping
                        </a>
                    </div>
                </div>

                <div class="order-summary-col">
                    
                    <div class="content-card">
                        <h2 class="card-title">
                            <svg class="w-5 h-5 mr-2" style="width: 1.25rem; height: 1.25rem; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                            Shipping Address
                        </h2>
                        
                        <form id="shipping-form" class="form-stack">
                            <div>
                                <label for="name" class="form-label">Full Name</label>
                                <input type="text" id="name" name="name" required autocomplete="name" class="form-input" placeholder="John Doe">
                            </div>

                            <div>
                                <label for="address1" class="form-label">Address Line 1</label>
                                <input type="text" id="address1" name="address1" required autocomplete="shipping street-address" class="form-input" placeholder="123 Main St">
                            </div>

                            <div>
                                <label for="address2" class="form-label">Address Line 2 (Optional)</label>
                                <input type="text" id="address2" name="address2" autocomplete="shipping address-line2" class="form-input" placeholder="Apt, Suite, etc.">
                            </div>
                            
                            <div class="form-row">
                                <div>
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" id="city" name="city" required autocomplete="shipping locality" class="form-input">
                                </div>
                                <div>
                                    <label for="state_code" class="form-label">State / Province</label>
                                    <input type="text" id="state_code" name="state_code" autocomplete="shipping region" class="form-input">
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label for="zip" class="form-label">Zip / Postal Code</label>
                                    <input type="text" id="zip" name="zip" required autocomplete="shipping postal-code" class="form-input">
                                </div>
                                <div>
                                    <label for="country_code" class="form-label">Country</label>
                                    <select id="country_code" name="country_code" required autocomplete="shipping country" class="form-select">
                                        <option value="GB">United Kingdom</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="AU">Australia</option>
                                        <option value="DE">Germany</option>
                                        <option value="FR">France</option>
                                        <option value="ES">Spain</option>
                                        <option value="IT">Italy</option>
                                        <option value="NL">Netherlands</option>
                                    </select>
                                </div>
                            </div>

                            <button type="button" id="calc-shipping-btn" class="btn-calc">
                                <span>Calculate Shipping</span>
                                <div id="calc-spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-b-2 border-white" style="display: none; width: 1rem; height: 1rem; border-radius: 50%; border: 2px solid white; border-bottom-color: transparent; animation: spin 1s linear infinite; margin-left: 0.5rem;"></div>
                            </button>
                        </form>
                    </div>

                    <div class="summary-card">
                        <h2 class="text-xl font-bold text-gray-800 mb-4" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Total</h2>
                        
                        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem;">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="summary-subtotal">£{{ summary.subtotal }}</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping</span>
                                <span id="summary-shipping" style="font-weight: 500; color: #ea580c;">Calculated at next step</span>
                            </div>
                        </div>

                        <div class="summary-total">
                            <span>Total</span>
                            <span id="summary-total">£{{ summary.subtotal }}</span>
                        </div>

                        <div id="stripe-checkout-container" class="hidden" style="margin-bottom: 1rem;"></div>

                        <button id="pay-button-placeholder" disabled class="btn-pay">
                            Enter Address to Pay
                        </button>
                    </div>
                    
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');
        
        const calcBtn = document.getElementById('calc-shipping-btn');
        const calcSpinner = document.getElementById('calc-spinner');
        
        const summaryShipping = document.getElementById('summary-shipping');
        const summaryTotal = document.getElementById('summary-total');
        
        const payPlaceholder = document.getElementById('pay-button-placeholder');
        const stripeContainer = document.getElementById('stripe-checkout-container');

        let currentSubtotal = parseFloat("{{ summary.subtotal }}");
        let currentShipping = 0;

        document.body.addEventListener('cartUpdated', function(evt) {
            summaryShipping.innerHTML = '<span style="color: #ea580c;">Please recalculate</span>';
            payPlaceholder.classList.remove('hidden');
            payPlaceholder.disabled = true;
            stripeContainer.classList.add('hidden');
            stripeContainer.innerHTML = ''; 
            calcBtn.classList.remove('hidden');
            calcBtn.innerText = "Recalculate Shipping";
        });

        calcBtn.addEventListener('click', async () => {
            const form = document.getElementById('shipping-form');
            if(!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const address = Object.fromEntries(formData);

            calcBtn.disabled = true;
            calcSpinner.style.display = 'inline-block';

            try {
                const shippingResp = await fetch("{% url 'payments:calculate_shipping' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ address: address })
                });

                const shippingData = await shippingResp.json();

                if (!shippingResp.ok) throw new Error(shippingData.error || "Shipping calc failed");

                currentShipping = parseFloat(shippingData.shipping_cost);
                summaryShipping.innerText = `£${currentShipping.toFixed(2)}`;
                const total = currentSubtotal + currentShipping;
                summaryTotal.innerText = `£${total.toFixed(2)}`;

                const sessionResp = await fetch("{% url 'payments:create_checkout_session' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ address: address }) // Pass address to lock it in
                });

                const sessionData = await sessionResp.json();

                if (sessionData.clientSecret) {
                    payPlaceholder.classList.add('hidden');
                    stripeContainer.classList.remove('hidden');
                    
                    const checkout = await stripe.initEmbeddedCheckout({
                        clientSecret: sessionData.clientSecret,
                    });
                    checkout.mount('#stripe-checkout-container');
                    calcBtn.innerText = "Update Address";
                } else {
                    alert("Error initializing payment: " + sessionData.error);
                }

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            } finally {
                calcBtn.disabled = false;
                calcSpinner.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}