<div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Book a New Session</h2>

    {# Removed the form element and its hx-post #}
    <div>
        {% csrf_token %} {# Keep csrf token if there are other forms or for future use, though not directly used by these HTMX gets #}
        <div class="mb-4">
            <label for="enrollment_id" class="block text-sm font-medium text-gray-700">Select Offering:</label>
            <select id="enrollment_id" name="enrollment_id"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                    hx-get="{% url 'coaching_booking:get_booking_calendar' %}?year={{ initial_year }}&month={{ initial_month }}"
                    hx-target="#calendar-container"
                    hx-trigger="change"
                    hx-include="#coach_id, #enrollment_id"> {# Include coach_id as well #}
                <option value="">-- Select an Offering --</option>
                {% for enrollment in user_offerings %}
                    {% if enrollment.remaining_sessions > 0 and enrollment.is_active and not enrollment.is_expired %}
                        <option value="{{ enrollment.id }}" {% if selected_enrollment and selected_enrollment.id == enrollment.id %}selected{% endif %}>
                            {{ enrollment.offering.name }} ({{ enrollment.remaining_sessions }} sessions remaining)
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="mb-4">
            <label for="coach_id" class="block text-sm font-medium text-gray-700">Select Coach:</label>
            <select id="coach_id" name="coach_id"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                    hx-get="{% url 'coaching_booking:get_booking_calendar' %}?year={{ initial_year }}&month={{ initial_month }}"
                    hx-target="#calendar-container"
                    hx-trigger="change"
                    hx-include="#enrollment_id, #coach_id"> {# Include enrollment_id as well #}
                <option value="">-- Select a Coach --</option>
                {% if coaches %}
                    {% for coach in coaches %}
                        <option value="{{ coach.id }}" {% if selected_coach and selected_coach.id == coach.id %}selected{% endif %}>
                            {{ coach.user.get_full_name }}
                        </option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>

        {# Container for the calendar widget. It will initially load the calendar. #}
        <div class="flex flex-col md:flex-row gap-6 mt-6">
            <div id="calendar-container" class="md:w-2/3"
                 hx-trigger="load, change from:#enrollment_id, change from:#coach_id" {# Load on page load, or when selections change #}
                 hx-get="{% url 'coaching_booking:get_booking_calendar' %}?year={{ initial_year }}&month={{ initial_month }}&coach_id={{ selected_coach_id|default:'' }}&enrollment_id={{ selected_enrollment_id|default:'' }}"
                 hx-swap="innerHTML">
                <p class="text-gray-500">Select an offering and a coach to load the calendar.</p>
            </div>

            <div id="time-slots-column" class="md:w-1/3 border-l pl-6">
                <p class="text-sm text-gray-500 text-center italic py-4">Select a date above to see available times.</p>
            </div>
        </div>
    </div>
</div>