{% extends "base.html" %}
{% load static %}
{% load taster_tags %} 
{% load socialaccount %} 
{% url 'account_login' as login_url %}

{% block title %}
Expert Coaching to Unlock Your Potential - {{ block.super }}
{% endblock %}

{% block extra_head %}
<meta name="description" content="Find the perfect coach to help you achieve your personal and professional goals. Explore our coaching services and book a free taster session.">
<style>
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>
{% endblock %}

{% block content %}

<!-- =================================================================
HERO SECTION: Main call to action for the taster session.
================================================================== -->
<div class="container-fluid text-white" style="background: linear-gradient(45deg, #0f2027, #203a43, #2c5364); padding: 6rem 1.5rem;">
    <div class="container text-center">
        <h1 class="display-3 fw-bold">Unlock Your Full Potential</h1>
        <p class="lead my-4 col-md-8 mx-auto">Our expert coaches are here to guide you on your journey to success. Start today with a complimentary, no-obligation taster session.</p>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
            {% if has_pending_request %}
                {# State: LOGGED IN, ALREADY APPLIED (GREY/DISABLED) - Cannot apply twice #}
                <button 
                    type="button" 
                    class="btn btn-lg btn-secondary disabled fw-bold shadow-lg" 
                    title="You already have a pending or approved request. Please check your profile tab for status updates."
                >
                    Request Pending (Check Profile) ‚è≥
                </button>
            
            {% else %}
                {# State: LOGGED OUT or LOGGED IN, ELIGIBLE (GREEN/ACTIVE) - Always opens tasterSessionModal #}
                <button 
                    type="button" 
                    class="btn btn-lg btn-success fw-bold shadow-lg" 
                    data-bs-toggle="modal" 
                    data-bs-target="#tasterSessionModal"
                    title="Request your free session now"
                >
                    Request Your FREE Taster Session Today ‚úÖ
                </button>
            {% endif %}
            <a href="#coaching-offerings" class="btn btn-outline-light btn-lg px-4">Explore Offerings</a>
        </div>
    </div>
</div>

<!-- =================================================================
MEET THE COACHES: Human element introduced early.
================================================================== -->
<div class="py-5 bg-white">
    <div class="container text-center">
        <h2 class="display-5 fw-bold mb-5">Meet Our Expert Coaches</h2>
        <div class="row gx-4 gy-5">
            {% for coach in coaches %}
            <div class="col-lg-4 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    {% if coach.public_photo %}
                    <img class="card-img-top" src="{{ coach.public_photo.url }}" alt="{{ coach.user.get_full_name }}" style="height: 300px; object-fit: cover;">
                    {% else %}
                    <img class="card-img-top" src="{% static 'images/default_coach_avatar.png' %}" alt="Default Coach Avatar" style="height: 300px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body text-center">
                        <h5 class="card-title fw-bold">{{ coach.user.get_full_name }}</h5>
                        <p class="card-text text-muted fst-italic">"{{ coach.bio|truncatewords:15 }}"</p>
                        <a href="{% url 'coaching_booking:offer-list' %}?coach={{ coach.user.username }}" class="btn btn-outline-primary mt-3">View {{ coach.user.first_name }}'s Offerings</a>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted col-12">No active coaches are available at the moment.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- =================================================================
COACHING VS MENTORSHIP: Explaining the core services.
================================================================== -->
<div class="py-5" style="background-color: #f8f9fa;">
    <div class="container">
        <h2 class="display-5 fw-bold text-center mb-5">Coaching vs. Mentorship: Find Your Fit</h2>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card h-100 p-4 shadow-sm">
                    <h3 class="fw-bold text-success">üéØ Coaching: Guiding Your Expertise</h3>
                    <p class="mt-2 text-muted">Coaches work with you using your expertise to guide you to long-lasting, self-discovered solutions. It's <strong>forward-focused</strong> and performance-driven.</p>
                    <hr class="my-3">
                    <h4 class="fw-bold mb-3">Unique Value & Benefits</h4>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Deep self-discovery and unlocking your own potential.</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Sustainable, self-owned change for long-lasting habits.</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Strictly focused on measurable goals and accountability.</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>Proven to increase confidence and performance.</li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100 p-4 shadow-sm">
                    <h3 class="fw-bold text-primary">üó∫Ô∏è Mentorship: Sharing Their Experience</h3>
                    <p class="mt-2 text-muted">Mentors use their own expertise and knowledge to guide you through what they have found to work. It's <strong>experience-based</strong> and career-focused.</p>
                    <hr class="my-3">
                    <h4 class="fw-bold mb-3">Unique Value & Benefits</h4>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i>Direct knowledge transfer and learning best practices.</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i>Accelerated career growth and industry-specific wisdom.</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-primary me-2"></i>Valuable networking and sponsorship opportunities.</li>
                        <li><i class="fas fa-check-circle text-primary me-2"></i>Proven to increase promotion rates and retention.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =================================================================
OFFERINGS CAROUSEL: Displaying the packages.
================================================================== -->
<div class="py-5 bg-white">
    <div class="container">
        <h2 id="coaching-offerings" class="display-5 fw-bold text-center mb-2 scroll-mt-5">Our Coaching Offerings</h2>
        <p class="lead text-center text-muted mb-5">Find the perfect package to start your journey.</p>
        
        <div x-data="carousel()" x-init="init()" class="position-relative w-100 mx-auto">
            <div class="overflow-hidden">
                <div x-ref="track" class="d-flex transition-transform duration-500 ease-in-out" :style="'transform: translateX(-' + (currentIndex * (100 / slidesVisible)) + '%)'">
                    {% for offering in offerings %}
                    <div class="w-100 flex-shrink-0" :style="'flex-basis: ' + (100 / slidesVisible) + '%'">
                        <div class="p-3">
                            <div class="card h-100 shadow-lg border-light hover-lift">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="card-title h4 fw-bold text-primary">{{ offering.name }}</h3>
                                    <p class="display-6 fw-bold text-dark my-3">¬£{{ offering.price|floatformat:2 }}</p>
                                    <p class="text-muted small mb-4 flex-grow-1">{{ offering.description|truncatechars:120 }}</p>
                                    <ul class="list-unstyled text-muted small mb-4">
                                        <li><i class="fas fa-clock text-success me-2"></i> Duration: {{ offering.display_length }}</li>
                                        <li><i class="fas fa-calendar-check text-success me-2"></i> Sessions: {{ offering.total_number_of_sessions }}</li>
                                        <li><i class="fas fa-users text-success me-2"></i> Coaches: {{ offering.coaches.count }}</li>
                                    </ul>
                                    <a href="{% url 'coaching_booking:offer-enroll' slug=offering.slug %}" class="btn btn-primary mt-auto">View Details & Enroll</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center text-muted col-12">No active offerings available at the moment. Please check back soon!</p>
                    {% endfor %}
                </div>
            </div>

            <button @click="prev()" class="btn btn-light btn-lg rounded-circle shadow position-absolute top-50 start-0 translate-middle-y ms-n3 z-index-1">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button @click="next()" class="btn btn-light btn-lg rounded-circle shadow position-absolute top-50 end-0 translate-middle-y me-n3 z-index-1">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="text-center mt-4">
            <a href="{% url 'coaching_booking:offer-list' %}" class="btn btn-outline-primary">See All Offerings <i class="fas fa-arrow-right ms-1"></i></a>
        </div>
    </div>
</div>

<!-- =================================================================
PROVEN RESULTS (KNOWLEDGE BASE): Social proof.
================================================================== -->
<div class="py-5" style="background-color: #f8f9fa;">
    <div class="container">
        <h2 class="display-5 fw-bold text-center mb-5">Proven Results in the Industry</h2>
        <div class="row g-4">
            {% for fact in facts %}
            {% with fact.statistic_description.split'|' as stat_desc %}
            <div class="col-lg-4">
                <div class="card text-center h-100 shadow-sm p-4">
                    <p class="display-4 fw-bold text-success">{{ stat_desc.0 }}</p>
                    <p class="h5 fw-normal mt-2">{{ stat_desc.1 }}</p>
                    {% if fact.source_link %}
                    <a href="{{ fact.source_link }}" target="_blank" rel="noopener" class="text-muted small mt-3">Source: {{ fact.source_title }} <i class="fas fa-external-link-alt fa-xs"></i></a>
                    {% else %}
                    <span class="text-muted small mt-3">Source: {{ fact.source_title }}</span>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <p class="text-center text-muted col-12">No facts available at the moment.</p>
            {% endfor %}
        </div>
    </div>
</div>


<!-- =================================================================
MODALS & SCRIPTS: Kept at the bottom for clarity.
================================================================== -->
<div class="modal fade" id="tasterSessionModal" tabindex="-1" aria-labelledby="tasterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            {# The improved partial is included here #}
            {% include "coaching_client/partials/_taster_request_content.html" with form=taster_request_form %}
        </div>
    </div>
</div>

<script>
// Show Django messages as a Bootstrap Toast
// NOTE: Assumes a toast container exists in base.html
document.addEventListener('DOMContentLoaded', function() {
    {% if messages %}
    var toastContainer = document.getElementById('toast-container');
    if (toastContainer) {
        {% for message in messages %}
        var toastHTML = `
            <div class="toast align-items-center text-white bg-{{ message.tags }} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        {{ message|safe }}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;
        toastContainer.innerHTML += toastHTML;
        {% endfor %}
        var toasts = [].slice.call(toastContainer.querySelectorAll('.toast'));
        toasts.forEach(function(toast) {
            new bootstrap.Toast(toast, { delay: 5000 }).show();
        });
    } else {
        {% for message in messages %}
            alert("{{ message }}"); // Fallback to basic alert
        {% endfor %}
    }
    {% endif %}
});
</script>

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
});

function carousel() {
    return {
        currentIndex: 0,
        totalSlides: {{ offerings|length|default:0 }},
        slidesVisible: 3,
        init() {
            this.updateSlidesVisible();
            window.addEventListener('resize', () => this.updateSlidesVisible());
            if (this.totalSlides <= this.slidesVisible) {
                this.currentIndex = 0;
            }
        },
        updateSlidesVisible() {
            if (window.innerWidth < 768) { this.slidesVisible = 1; }
            else if (window.innerWidth < 992) { this.slidesVisible = 2; }
            else { this.slidesVisible = 3; }
        },
        next() {
            if (this.totalSlides > this.slidesVisible) {
                this.currentIndex = (this.currentIndex + 1) % (this.totalSlides - this.slidesVisible + 1);
            }
        },
        prev() {
            if (this.totalSlides > this.slidesVisible) {
                this.currentIndex = (this.currentIndex - 1 + (this.totalSlides - this.slidesVisible + 1)) % (this.totalSlides - this.slidesVisible + 1);
            }
        }
    }
}
</script>
{% endblock %}
