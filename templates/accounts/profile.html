{% extends 'base.html' %}

{% block title %}My Account Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-10">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">ðŸ‘‹ Welcome, {{ user.first_name|default:user.username }}</h1>
    <p class="text-gray-600 mb-8">This is your centralized account dashboard.</p>



    <div x-data="{ activeTab: 'account' }" class="w-full">
        <!-- Tab Headers -->
        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" data-tabs-toggle="#myTabContent" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="account-tab" type="button" role="tab" aria-controls="account" aria-selected="true" @click="activeTab = 'account'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'account', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'account' }">Account Information</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="my-coaching-tab" type="button" role="tab" aria-controls="my-coaching" aria-selected="false" @click="activeTab = 'my-coaching'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'my-coaching', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'my-coaching' }">My Coaching</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="book-session-tab" type="button" role="tab" aria-controls="book-session" aria-selected="false" @click="activeTab = 'book-session'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'book-session', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'book-session' }">Book Session</button>
                </li>
                {% if is_coach %}
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="coach-tab" type="button" role="tab" aria-controls="coach" aria-selected="false" @click="activeTab = 'coach'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'coach', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'coach' }">Coach Dashboard</button>
                </li>
                {% endif %}
                {% if is_staff %}
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="staff-tab" type="button" role="tab" aria-controls="staff" aria-selected="false" @click="activeTab = 'staff'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'staff', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'staff' }">Staff Dashboard</button>
                </li>
                {% endif %}
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="integrations-tab" type="button" role="tab" aria-controls="integrations" aria-selected="false" @click="activeTab = 'integrations'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'integrations', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'integrations' }">Integrations</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="preferences-tab" type="button" role="tab" aria-controls="preferences" aria-selected="false" @click="activeTab = 'preferences'" :class="{ 'border-blue-600 text-blue-600': activeTab === 'preferences', 'hover:text-gray-600 hover:border-gray-300': activeTab !== 'preferences' }">Preferences</button>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div id="myTabContent">
            <!-- Account Information Tab -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="account" role="tabpanel" aria-labelledby="account-tab" x-show="activeTab === 'account'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Account Information</h2>
                    <ul class="space-y-2 text-gray-700">
                        <li><strong>Username:</strong> {{ user.username }}</li>
                        <li><strong>Email:</strong> {{ user.email }}</li>
                        <li><strong>Joined:</strong> {{ user.date_joined|date:"M d, Y" }}</li>
                    </ul>
                </div>
            </div>

            <!-- My Coaching Tab -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="my-coaching" role="tabpanel" aria-labelledby="my-coaching-tab" x-show="activeTab === 'my-coaching'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">My Coaching Sessions</h2>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Upcoming Sessions</h3>
                    {% if client_upcoming_sessions %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for session in client_upcoming_sessions %}
                                <li>{{ session.start_datetime|date:"M d, H:i" }} with {{ session.coach.get_full_name|default:session.coach.username }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No upcoming sessions.</p>
                    {% endif %}

                    <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Past Sessions</h3>
                    {% if client_past_sessions %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for session in client_past_sessions %}
                                <li>{{ session.start_datetime|date:"M d, H:i" }} with {{ session.coach.get_full_name|default:session.coach.username }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No past sessions.</p>
                    {% endif %}

                    <h2 class="text-xl font-semibold text-gray-800 mb-4 mt-8">My Coaching Offerings</h2>
                    {% if user_offerings %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for offering in user_offerings %}
                                <li>{{ offering.offering.name }} - Remaining Sessions: {{ offering.remaining_sessions }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>You have not purchased any coaching offerings yet.</p>
                    {% endif %}

                    <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Available Credits</h3>
                    {% if available_credits %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for credit in available_credits %}
                                <li>{{ credit.offering.name }} - {{ credit.remaining_sessions }} sessions remaining (Expires: {{ credit.expiration_date|date:"M d, Y" }})</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No available coaching credits.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Book Session Tab -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="book-session" role="tabpanel" aria-labelledby="book-session-tab" x-show="activeTab === 'book-session'" hx-get="{% url 'accounts:profile_book_session' %}" hx-trigger="load once" hx-swap="innerHTML">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Book a New Session</h2>
                    <!-- Content will be loaded via HTMX -->
                    <p>Loading session booking form...</p>
                </div>
            </div>

            <!-- Coach Dashboard Tab -->
            {% if is_coach %}
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="coach" role="tabpanel" aria-labelledby="coach-tab" x-show="activeTab === 'coach'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Coach Dashboard Elements</h2>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Upcoming Sessions</h3>
                    {% if coach_upcoming_sessions %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for session in coach_upcoming_sessions %}
                                <li>{{ session.start_datetime|date:"M d, H:i" }} with {{ session.client.username }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No upcoming sessions.</p>
                    {% endif %}

                    <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Your Clients</h3>
                    {% if coach_clients %}
                        <ul class="list-disc list-inside space-y-1">
                            {% for client in coach_clients %}
                                <li>{{ client }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No clients assigned yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Staff Dashboard Tab -->
            {% if is_staff %}
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="staff" role="tabpanel" aria-labelledby="staff-tab" x-show="activeTab === 'staff'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Staff Dashboard Elements</h2>
                    <p>This section is visible to staff members.</p>
                    {# TODO: Include actual staff dashboard components here #}
                </div>
            </div>
            {% endif %}

            <!-- Integrations Tab -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="integrations" role="tabpanel" aria-labelledby="integrations-tab" x-show="activeTab === 'integrations'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Google Calendar</h2>
                    <p class="text-gray-600 mb-4">Connect your Google Calendar to automatically sync your coaching sessions.</p>
                    <a href="{% url 'gcal:google_calendar_init' %}" class="w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                        Connect to Google Calendar
                    </a>
                </div>
            </div>

            <!-- Preferences Tab -->
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="preferences" role="tabpanel" aria-labelledby="preferences-tab" x-show="activeTab === 'preferences'">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Marketing Preferences</h2>
                    {% with marketing_preference=user.marketing_preference %}
                    <form hx-post="{% url 'account:update_marketing_preference' %}" 
                          hx-target="#marketing-preference-status-wrapper" hx-swap="innerHTML">
                        {% csrf_token %}
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" name="is_subscribed" id="marketing_opt_in"
                                   {% if marketing_preference.is_subscribed %}checked{% endif %}
                                   hx-post="{% url 'account:update_marketing_preference' %}"
                                   hx-trigger="change"
                                   hx-target="#marketing-preference-status-wrapper"
                                   hx-swap="innerHTML"
                                   class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <label for="marketing_opt_in" class="text-gray-700">
                                Receive marketing emails
                            </label>
                        </div>
                    </form>
                    <div id="marketing-preference-status-wrapper" class="mt-3">
                        <p id="marketing-preference-status" class="text-sm">
                            Current status: <strong class="{% if marketing_preference.is_subscribed %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if marketing_preference.is_subscribed %}Subscribed{% else %}Unsubscribed{% endif %}
                            </strong>
                        </p>
                    </div>
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>



</div>
{% endblock %}