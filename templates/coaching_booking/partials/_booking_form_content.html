{% with unique_suffix=reschedule_booking_id|default:"new" %}
<div class="{% if not is_inline %}bg-white p-6 rounded-lg shadow-lg{% elif is_modal %}p-6{% else %}mt-4 border-t border-gray-100 pt-6{% endif %}">
    {% if not is_inline %}
    <h2 class="text-2xl font-bold text-gray-800 mb-6">
        {% if reschedule_booking_id %}
            Reschedule Session
        {% else %}
            Book a New Session
        {% endif %}
    </h2>
    {% endif %}

    <div>
        {% csrf_token %}
        <div id="booking-errors" class="mb-4"></div>
        
        {# --- Logic to Hide Dropdown if Rescheduling --- #}
        {% if not reschedule_booking_id %}
            <div class="mb-6">
                <label for="enrollment_id_{{ unique_suffix }}" class="block text-sm font-medium text-gray-700">Select Offering:</label>
                {# Updated ID to be unique #}
                <select id="enrollment_id_{{ unique_suffix }}" name="enrollment_id"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">-- Select an Offering --</option>
                    {% if user_offerings %}
                        <optgroup label="Paid Enrollments">
                        {% for enrollment in user_offerings %}
                            {% if enrollment.remaining_sessions > 0 and enrollment.is_active and not enrollment.is_expired %}
                                <option value="{{ enrollment.id }}" 
                                        {% if selected_enrollment_id == enrollment.id|stringformat:"s" %}selected{% endif %}>
                                    {{ enrollment.offering.name }} ({{ enrollment.remaining_sessions }} left) - With {{ enrollment.coach.user.get_full_name }}
                                </option>
                            {% endif %}
                        {% endfor %}
                        </optgroup>
                    {% endif %}

                    {% if free_offers %}
                        <optgroup label="Free Taster Sessions">
                        {% for offer in free_offers %}
                            <option value="free_{{ offer.id }}" {% if selected_free_offer_id == offer.id|stringformat:"s" %}selected{% endif %}>
                                Free Taster Session with {{ offer.coach.user.get_full_name }}
                            </option>
                        {% endfor %}
                        </optgroup>
                    {% endif %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Bookings are made with the coach assigned to your package.</p>
            </div>
        {% else %}
            <div class="mb-6 bg-blue-50 p-4 rounded border border-blue-100">
                <p class="text-blue-800 font-semibold">Rescheduling Session</p>
                <p class="text-sm text-blue-600">
                    Originally with {{ booking.coach.user.get_full_name }}<br>
                    Current time: {{ booking.start_datetime|date:"F j, Y, g:i a" }}
                </p>
                <input type="hidden" id="reschedule_booking_id_{{ unique_suffix }}" name="reschedule_booking_id" value="{{ reschedule_booking_id }}">
            </div>
        {% endif %}

        {# --- Legend for Calendar --- #}
        <div class="flex flex-wrap gap-4 mb-4 text-sm justify-center md:justify-start">
            <div class="flex items-center">
                <span class="w-4 h-4 inline-block bg-green-100 border border-green-200 rounded mr-2"></span>
                <span class="text-gray-700">Available</span>
            </div>
            <div class="flex items-center">
                <span class="w-4 h-4 inline-block bg-red-100 border border-red-200 rounded mr-2"></span>
                <span class="text-gray-700">Fully Booked</span>
            </div>
            <div class="flex items-center">
                <span class="w-4 h-4 inline-block bg-red-50 border border-red-100 rounded mr-2"></span>
                <span class="text-gray-700">Past / Unavailable</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            
            {# Left Column: Calendar (Takes 2/3 space) #}
            {# Added dynamic ID and Updated hx-trigger/include/get to use unique_suffix and pass slot_target_id #}
            <div id="calendar-container-{{ unique_suffix }}" class="md:col-span-2 min-w-0"
                 hx-trigger="load, revealed, intersect{% if not reschedule_booking_id %}, change from:#enrollment_id_{{ unique_suffix }}{% endif %}"
                 hx-get="{% url 'coaching_booking:get_booking_calendar' %}?year={{ initial_year }}&month={{ initial_month }}{% if reschedule_booking_id %}&reschedule_booking_id={{ reschedule_booking_id }}{% endif %}{% if selected_enrollment_id %}&enrollment_id={{ selected_enrollment_id }}{% endif %}&slot_target_id=%23time-slots-column-{{ unique_suffix }}"
                 {% if not reschedule_booking_id %}hx-include="#enrollment_id_{{ unique_suffix }}"{% endif %}
                 hx-swap="innerHTML">
                
                <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <p class="text-gray-500 font-medium">
                        {% if reschedule_booking_id %}
                            Loading calendar...
                        {% else %}
                            Select an Offering to view your coach's availability.
                        {% endif %}
                    </p>
                </div>
            </div>

            {# Right Column: Time Slots (Takes 1/3 space) #}
            {# Added dynamic ID #}
            <div id="time-slots-column-{{ unique_suffix }}" class="md:col-span-1 min-w-0 border-l pl-6">
                <p class="text-sm text-gray-500 text-center italic py-4">Select a date above to see available times.</p>
            </div>
        </div>
    </div>
</div>
{% endwith %}